<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Adalet SimÃ¼lasyonu</title>
    
    <!-- KÃ¼tÃ¼phaneler -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    
    <style>
        :root { --primary-navy: #0f172a; }
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #020617; 
            color: #f1f5f9;
            height: 100dvh; 
            width: 100vw;
            overflow: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        /* --- VIP CHAT STÄ°LÄ° --- */
        .vip-msg {
            background: linear-gradient(90deg, #422006 0%, #713f12 100%);
            border: 2px solid #facc15;
            box-shadow: 0 0 15px rgba(250, 204, 21, 0.5);
            animation: pulse-gold 2s infinite;
        }
        @keyframes pulse-gold { 50% { box-shadow: 0 0 25px rgba(250, 204, 21, 0.8); } }
        
        /* --- KANIT LÄ°STESÄ° STÄ°LÄ° --- */
        .evidence-item {
            background-color: rgba(30, 41, 59, 0.6);
            border: 1px solid rgba(71, 85, 105, 0.5);
            transition: all 0.2s;
        }
        .evidence-item:active { transform: scale(0.98); background-color: rgba(51, 65, 85, 0.8); }

        /* --- DÄ°ÄER --- */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .blur-overlay { filter: blur(10px); pointer-events: none; user-select: none; }
        .nav-item.active { color: #fbbf24; border-top: 3px solid #fbbf24; background: rgba(30, 41, 59, 0.9); }
        
        .msg-enter { animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Neon Metinler */
        .neon-pink { color: #f472b6; text-shadow: 0 0 8px #be185d; }
        .neon-cyan { color: #22d3ee; text-shadow: 0 0 8px #0e7490; }
        .neon-lime { color: #a3e635; text-shadow: 0 0 8px #4d7c0f; }
        .neon-amber { color: #fbbf24; text-shadow: 0 0 8px #b45309; }
        
        .avatar-option.selected { border: 3px solid #fbbf24; box-shadow: 0 0 20px #fbbf24; transform: scale(1.1); }
    </style>
</head>
<body class="bg-slate-950 text-slate-100">

    <script src="https://www.gstatic.com/firebasejs/10.9.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.9.0/firebase-firestore-compat.js"></script>

    <audio id="alert-sound" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" preload="auto"></audio>
    <audio id="applause-sound" src="https://actions.google.com/sounds/v1/crowds/battle_crowd_celebrate_stutter.ogg" preload="auto"></audio>
    <audio id="shh-sound" src="https://actions.google.com/sounds/v1/foley/cassette_tape_button.ogg" preload="auto"></audio>

    <!-- 1. GÄ°RÄ°Å EKRANI -->
    <div id="login-screen" class="absolute inset-0 z-50 bg-slate-950 flex flex-col items-center justify-center p-4">
        <div class="text-center w-full max-w-md mb-6 relative z-10">
            <div class="bg-white p-3 rounded-full mb-4 inline-block shadow-[0_0_30px_rgba(255,255,255,0.2)]">
                <img src="https://upload.wikimedia.org/wikipedia/tr/c/cc/Ataturkuni_logo.png?20200406213338" alt="Logo" class="w-20 h-20 object-contain">
            </div>
            <h2 class="text-[10px] font-bold text-slate-400 tracking-[0.3em] uppercase mb-1">ATATÃœRK ÃœNÄ°VERSÄ°TESÄ°</h2>
            <h3 class="text-xs text-yellow-400 font-bold tracking-widest border-b border-slate-800 pb-2 inline-block px-4 mb-2">SOSYAL BÄ°LGÄ°LER Ã–ÄRETMENLÄ°ÄÄ°</h3>
            <h1 class="text-4xl font-black tracking-widest text-white drop-shadow-lg">ADALET SÄ°M.</h1>
            <p class="text-slate-500 text-[10px] italic mt-2">HazÄ±rlayan: Muhammet Emin AydÄ±n</p>
        </div>

        <div class="w-full max-w-xs space-y-3 mb-4 z-10">
            <input type="text" id="juri-ad" placeholder="Ã–ÄŸrenci AdÄ± SoyadÄ±" class="w-full p-4 bg-slate-900/80 backdrop-blur rounded-xl border border-slate-700 text-white focus:border-yellow-500 outline-none text-center text-sm shadow-inner transition placeholder-slate-600">
        </div>

        <div class="w-full max-w-md flex-1 overflow-y-auto no-scrollbar bg-slate-900/50 p-4 rounded-xl border border-slate-800 mb-24 relative z-10 shadow-inner">
            <p class="text-center text-xs text-slate-400 mb-3 font-bold sticky top-0 bg-slate-900/95 py-2 z-20 border-b border-slate-800">KOLTUK SEÃ‡Ä°MÄ° ğŸ‘‡</p>
            <div id="koltuk-grid" class="grid grid-cols-5 gap-3 pb-4"></div>
        </div>

        <div class="fixed bottom-8 left-0 right-0 flex gap-4 w-full max-w-md mx-auto px-6 z-50 items-center">
            <button onclick="openAdminLogin('teacher')" class="flex-1 text-slate-900 font-black py-4 rounded-2xl transition flex items-center justify-center gap-2 text-xs bg-yellow-500 shadow-[0_0_15px_#eab308] border-2 border-yellow-200 active:scale-95"><i class="fa-solid fa-chalkboard-user text-xl"></i> Ã–ÄRETMEN</button>
            <button onclick="openAdminLogin('judge')" class="flex-1 text-white font-bold py-4 rounded-2xl transition flex items-center justify-center gap-2 text-xs bg-slate-700 shadow-[0_0_15px_#64748b] border-2 border-slate-500 active:scale-95"><i class="fa-solid fa-scale-balanced text-xl"></i> HAKÄ°M</button>
            <button onclick="openProjectorMode()" class="w-16 h-16 text-white rounded-2xl flex items-center justify-center bg-cyan-600 shadow-[0_0_15px_#06b6d4] border-2 border-cyan-300 active:scale-95"><i class="fa-solid fa-tv text-2xl"></i></button>
        </div>
    </div>

    <!-- AVATAR MODAL -->
    <div id="avatar-modal" class="hidden fixed inset-0 z-[200] bg-slate-950 flex flex-col items-center justify-center p-6">
        <h2 class="text-2xl font-bold text-white mb-8 text-purple-400 drop-shadow-[0_0_10px_#a855f7]">AVATARINI SEÃ‡</h2>
        <div class="grid grid-cols-2 gap-6 mb-8">
            <div onclick="selectAvatar('m1')" class="avatar-option w-24 h-24 bg-blue-900/50 rounded-full border-2 border-blue-500 flex items-center justify-center cursor-pointer transition" id="av-m1"><i class="fa-solid fa-user-tie text-4xl text-blue-300"></i></div>
            <div onclick="selectAvatar('m2')" class="avatar-option w-24 h-24 bg-blue-900/50 rounded-full border-2 border-blue-500 flex items-center justify-center cursor-pointer transition" id="av-m2"><i class="fa-solid fa-user-graduate text-4xl text-blue-300"></i></div>
            <div onclick="selectAvatar('f1')" class="avatar-option w-24 h-24 bg-pink-900/50 rounded-full border-2 border-pink-500 flex items-center justify-center cursor-pointer transition" id="av-f1"><i class="fa-solid fa-user-nurse text-4xl text-pink-300"></i></div>
            <div onclick="selectAvatar('f2')" class="avatar-option w-24 h-24 bg-pink-900/50 rounded-full border-2 border-pink-500 flex items-center justify-center cursor-pointer transition" id="av-f2"><i class="fa-solid fa-user-doctor text-4xl text-pink-300"></i></div>
        </div>
        <button onclick="confirmSeatWithAvatar()" class="bg-green-600 hover:bg-green-500 text-white px-8 py-3 rounded-xl font-bold shadow-lg transition transform active:scale-95">GÄ°RÄ°Å YAP</button>
    </div>

    <!-- 2. Ã–ÄRENCÄ° ARAYÃœZÃœ -->
    <div id="app-interface" class="hidden absolute inset-0 z-10 flex flex-col bg-slate-100">
        <header class="bg-slate-900 text-white p-3 flex justify-between items-center shadow-lg h-16 flex-shrink-0 relative z-30">
            <div><span class="text-[9px] text-slate-400 uppercase tracking-wider block">Dosya No: 2025/456</span><span id="header-user-name" class="font-bold text-yellow-400 text-xs">JÃ¼ri Ãœyesi</span></div>
            <div class="flex items-center gap-3"><div class="bg-slate-800 px-3 py-1 rounded-full border border-yellow-500/30 flex items-center gap-1 shadow-[0_0_10px_rgba(250,204,21,0.3)]"><i class="fa-solid fa-star text-yellow-500 text-xs"></i><span id="my-score" class="text-xs font-bold text-white">0</span></div><button onclick="logoutUser()" class="text-slate-400 hover:text-red-400 p-2"><i class="fa-solid fa-right-from-bracket"></i></button></div>
        </header>

        <button onclick="requestSpeech()" class="fixed bottom-24 left-4 z-40 bg-yellow-500 text-slate-900 p-4 rounded-full shadow-[0_0_20px_rgba(250,204,21,0.6)] w-16 h-16 flex flex-col items-center justify-center border-4 border-white/20 active:scale-90 transition"><i class="fa-solid fa-hand text-xl"></i><span class="text-[9px] font-bold mt-1">SÃ–Z</span></button>

        <main class="flex-1 overflow-y-auto no-scrollbar relative w-full pb-20 bg-slate-200 text-slate-800">
            <!-- CANLI -->
            <div id="tab-live" class="tab-content active p-4 space-y-4">
                <div class="bg-white p-6 rounded-2xl shadow-lg border-l-4 border-blue-600">
                    <h3 class="font-bold text-slate-800 mb-4 text-center text-sm">VÄ°CDANÄ° KANAAT</h3>
                    <input type="range" id="sentiment-slider" min="0" max="100" value="50" step="10" class="w-full h-4 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-blue-600">
                    <div class="flex justify-between text-[10px] font-bold mt-2 px-1"><span class="text-red-600">DAVACI</span><span class="text-green-600">SANIK</span></div>
                    <p id="sentiment-status" class="text-center text-[10px] text-slate-400 mt-2 h-4"></p>
                </div>
            </div>
            
            <!-- KANITLAR (YENÄ° TASARIM: LÄ°STE & POPUP) -->
            <div id="tab-evidence" class="tab-content hidden p-4 space-y-4">
                <div class="flex items-center justify-between border-b border-slate-300 pb-2"><span class="text-xs font-black text-slate-600 uppercase">DELÄ°L DOSYASI</span><i class="fa-solid fa-folder-open text-yellow-500"></i></div>
                
                <div class="space-y-3">
                    <!-- Video Item -->
                    <div onclick="openVideoModal()" class="evidence-item rounded-xl p-4 flex items-center justify-between cursor-pointer bg-slate-800 text-white shadow-md border-l-4 border-red-500">
                        <div class="flex items-center gap-4">
                            <div class="w-10 h-10 rounded-full bg-red-900/50 flex items-center justify-center"><i class="fa-solid fa-video text-red-400"></i></div>
                            <div><h4 class="font-bold text-sm">Olay Yeri KaydÄ±</h4><p class="text-[10px] text-slate-400">Kriminal Ä°nceleme</p></div>
                        </div>
                        <i class="fa-solid fa-play text-slate-500"></i>
                    </div>

                    <!-- Image Item 1 -->
                    <div onclick="openImage('WP1.png')" class="evidence-item rounded-xl p-4 flex items-center justify-between cursor-pointer bg-white text-slate-800 shadow-sm border border-slate-200">
                        <div class="flex items-center gap-4">
                            <div class="w-10 h-10 rounded-full bg-green-100 flex items-center justify-center"><i class="fa-brands fa-whatsapp text-green-600 text-xl"></i></div>
                            <div><h4 class="font-bold text-sm">WhatsApp KaydÄ± #1</h4><p class="text-[10px] text-slate-500">TartÄ±ÅŸma BaÅŸlangÄ±cÄ±</p></div>
                        </div>
                        <i class="fa-solid fa-eye text-slate-300"></i>
                    </div>

                    <!-- Image Item 2 -->
                    <div onclick="openImage('WP2.png')" class="evidence-item rounded-xl p-4 flex items-center justify-between cursor-pointer bg-white text-slate-800 shadow-sm border border-slate-200">
                        <div class="flex items-center gap-4">
                            <div class="w-10 h-10 rounded-full bg-red-100 flex items-center justify-center"><i class="fa-solid fa-triangle-exclamation text-red-600 text-xl"></i></div>
                            <div><h4 class="font-bold text-sm">WhatsApp KaydÄ± #2</h4><p class="text-[10px] text-slate-500">Tehdit UnsurlarÄ±</p></div>
                        </div>
                        <i class="fa-solid fa-eye text-slate-300"></i>
                    </div>
                </div>
            </div>

            <!-- CHAT -->
            <div id="tab-chat" class="tab-content hidden flex-col h-full">
                <div id="mobile-chat-feed" class="flex-1 p-4 space-y-3 overflow-y-auto pb-20"></div>
                <div class="bg-white p-3 border-t flex gap-2 items-center safe-area-bottom sticky bottom-0 shadow-lg"><input type="text" id="chat-input" class="flex-1 bg-slate-100 rounded-full px-4 py-3 text-sm outline-none border focus:border-blue-500" placeholder="Yaz..."><button onclick="sendChat()" class="bg-blue-600 text-white w-10 h-10 rounded-full shadow active:scale-90 transition"><i class="fa-solid fa-paper-plane"></i></button></div>
            </div>

            <!-- SORU -->
            <div id="tab-comm" class="tab-content hidden p-4"><div class="bg-indigo-50 p-5 rounded-xl border border-indigo-100 shadow-sm"><h3 class="font-bold text-indigo-900 text-sm mb-3">Hakime Soru</h3><textarea id="question-input" rows="4" class="w-full p-3 rounded-lg text-sm border border-indigo-200 focus:outline-none" placeholder="..."></textarea><button onclick="sendQuestion()" class="w-full mt-3 bg-indigo-600 text-white py-3 rounded-lg text-sm font-bold shadow-md active:scale-95">GÃ–NDER</button></div></div>

            <!-- KARAR -->
            <div id="tab-vote" class="tab-content hidden p-6 flex-col justify-center space-y-6 h-full">
                <h2 class="text-center font-black text-2xl text-slate-800">KARAR VAKTÄ°</h2>
                <button onclick="submitVote('SUÃ‡LU')" class="w-full py-4 bg-red-600 text-white rounded-xl shadow-lg font-bold text-lg active:scale-95 transition border-b-4 border-red-800">SUÃ‡LU</button>
                <button onclick="submitVote('SUÃ‡SUZ')" class="w-full py-4 bg-green-600 text-white rounded-xl shadow-lg font-bold text-lg active:scale-95 transition border-b-4 border-green-800">SUÃ‡SUZ</button>
                <p id="vote-status" class="text-center font-bold text-blue-600 text-sm mt-2"></p>
            </div>
        </main>

        <nav class="bg-slate-900 border-t border-slate-800 flex justify-around pb-6 pt-3 h-20 shadow-[0_-5px_15px_rgba(0,0,0,0.3)] z-50 fixed bottom-0 left-0 right-0 w-full text-[10px] text-slate-400">
            <button onclick="switchTab('tab-live', this)" class="nav-item active flex flex-col items-center w-1/5 gap-1"><i class="fa-solid fa-tower-broadcast text-lg"></i>CanlÄ±</button>
            <button onclick="switchTab('tab-evidence', this)" class="nav-item flex flex-col items-center w-1/5 gap-1"><i class="fa-solid fa-folder-open text-lg"></i>KanÄ±t</button>
            <button onclick="switchTab('tab-chat', this)" class="nav-item flex flex-col items-center w-1/5 gap-1"><i class="fa-solid fa-comments text-lg"></i>Sohbet</button>
            <button onclick="switchTab('tab-comm', this)" class="nav-item flex flex-col items-center w-1/5 gap-1"><i class="fa-solid fa-question text-lg"></i>Soru</button>
            <button onclick="switchTab('tab-vote', this)" class="nav-item flex flex-col items-center w-1/5 gap-1"><i class="fa-solid fa-check-to-slot text-lg"></i>Karar</button>
        </nav>
    </div>

    <!-- JÃœRÄ° KARTI -->
    <div id="juror-card-modal" class="hidden fixed inset-0 z-[250] bg-black/80 flex items-center justify-center p-6" onclick="this.classList.add('hidden')">
        <div class="bg-slate-800 w-full max-w-sm rounded-2xl border-2 border-yellow-500 shadow-[0_0_40px_rgba(234,179,8,0.3)] p-6 text-center" onclick="event.stopPropagation()">
            <div class="w-20 h-20 bg-slate-700 rounded-full mx-auto mb-4 flex items-center justify-center border-2 border-white shadow-lg"><i id="card-avatar" class="text-4xl text-white"></i></div>
            <h2 id="card-name" class="text-2xl font-bold text-white mb-1"></h2>
            <p class="text-slate-400 text-xs mb-4">Koltuk: <span id="card-seat" class="font-mono text-white"></span></p>
            <div class="bg-slate-900 rounded-xl p-4 border border-slate-700"><p class="text-xs text-slate-500 uppercase tracking-widest mb-1">PUAN</p><p id="card-score" class="text-4xl font-black text-yellow-400">0</p></div>
        </div>
    </div>

    <!-- 3. YÃ–NETÄ°CÄ° PANELÄ° -->
    <div id="admin-panel" class="hidden absolute inset-0 bg-slate-900 text-white z-[150] flex flex-col">
        <header class="flex justify-between items-center p-4 border-b border-slate-700 bg-slate-800"><h1 class="text-lg font-bold text-yellow-400" id="admin-title">YÃ–NETÄ°M</h1><button onclick="location.reload()" class="bg-red-900/50 px-3 py-1 rounded text-xs border border-red-800">Ã‡Ä±kÄ±ÅŸ</button></header>
        <div class="flex border-b border-slate-700 bg-slate-800 text-xs font-bold"><button onclick="switchAdminTab('panel-teacher')" class="flex-1 py-3 text-slate-400 border-b-2 border-transparent focus:text-yellow-400 focus:border-yellow-400 hidden" id="btn-tab-teacher">SINIF</button><button onclick="switchAdminTab('panel-judge')" class="flex-1 py-3 text-slate-400 border-b-2 border-transparent focus:text-yellow-400 focus:border-yellow-400" id="btn-tab-judge">DURUÅMA</button></div>
        <div class="flex-1 overflow-y-auto p-4 space-y-6">
            <!-- Ã–ÄRETMEN -->
            <div id="panel-teacher" class="hidden space-y-6">
                <!-- VIP Chat -->
                <div class="bg-slate-800 p-4 rounded-xl border border-slate-700">
                    <h3 class="text-xs font-bold text-yellow-400 mb-2 uppercase tracking-widest">ğŸ‘‘ VIP SÄ±nÄ±f Duyurusu</h3>
                    <div class="flex gap-2"><input type="text" id="teacher-chat-input" placeholder="SÄ±nÄ±fa Ã¶nemli bir mesaj gÃ¶nder..." class="flex-1 p-2 bg-slate-900 rounded border border-yellow-600/50 text-xs"><button onclick="sendTeacherChat()" class="bg-yellow-600 text-slate-900 font-bold px-4 rounded text-xs hover:bg-yellow-500">GÃ–NDER</button></div>
                </div>
                <!-- AraÃ§lar (Sessizlik, AlkÄ±ÅŸ vb.) -->
                <div class="bg-slate-800 p-4 rounded-xl border border-slate-700">
                    <h3 class="text-xs font-bold text-blue-400 mb-2 uppercase tracking-widest">SÄ±nÄ±f AraÃ§larÄ±</h3>
                    <div class="grid grid-cols-2 gap-2">
                        <button onclick="triggerClassEffect('silence')" class="bg-red-900/50 border border-red-600 text-red-200 p-3 rounded text-xs font-bold hover:bg-red-900"><i class="fa-solid fa-bell-slash mr-2"></i>SESSÄ°ZLÄ°K!</button>
                        <button onclick="triggerClassEffect('applause')" class="bg-purple-900/50 border border-purple-600 text-purple-200 p-3 rounded text-xs font-bold hover:bg-purple-900"><i class="fa-solid fa-hands-clapping mr-2"></i>ALKIÅLAT</button>
                        <button onclick="triggerClassEffect('bonus')" class="bg-green-900/50 border border-green-600 text-green-200 p-3 rounded text-xs font-bold col-span-2 hover:bg-green-900"><i class="fa-solid fa-star mr-2"></i>HERKESE +5 PUAN</button>
                    </div>
                </div>
                <!-- Quiz & Liste -->
                <div class="bg-slate-800 p-4 rounded-xl border border-slate-700"><h3 class="text-xs font-bold text-green-400 mb-2">QUIZ</h3><input type="text" id="quiz-q" placeholder="Soru" class="w-full p-2 bg-slate-900 rounded border border-slate-600 mb-2 text-xs"><div class="grid grid-cols-2 gap-2 mb-2"><input type="text" id="quiz-opt1" placeholder="A" class="p-2 bg-slate-900 text-xs"><input type="text" id="quiz-opt2" placeholder="B" class="p-2 bg-slate-900 text-xs"><input type="text" id="quiz-opt3" placeholder="C" class="p-2 bg-slate-900 text-xs"><input type="text" id="quiz-opt4" placeholder="D" class="p-2 bg-slate-900 text-xs"></div><select id="quiz-correct" class="w-full p-2 bg-slate-900 text-xs mb-2 text-slate-400"><option value="">DoÄŸru Cevap</option><option value="0">A</option><option value="1">B</option><option value="2">C</option><option value="3">D</option></select><div class="flex gap-2"><button onclick="publishQuiz()" class="flex-1 bg-green-600 py-2 rounded text-xs font-bold">YAYINLA</button><button onclick="closeQuiz()" class="bg-red-600 px-4 py-2 rounded text-xs font-bold">BÄ°TÄ°R</button></div><div class="h-32 mt-4 w-full"><canvas id="quizChart"></canvas></div></div>
                <div class="bg-slate-800 p-4 rounded-xl border border-slate-700"><h3 class="text-xs font-bold text-yellow-400 uppercase mb-2">SÄ±nÄ±f Listesi</h3><div class="overflow-x-auto h-64 overflow-y-auto"><table class="w-full text-xs text-left text-slate-400"><tbody id="teacher-attendance-list" class="divide-y divide-slate-700"></tbody></table></div></div>
            </div>
            <!-- Hakim -->
            <div id="panel-judge" class="hidden space-y-6">
                <div class="bg-slate-800 p-4 rounded-xl border border-slate-700 h-64 flex flex-col"><div class="flex justify-between items-center mb-2"><h3 class="text-sm font-bold text-red-400">JÃ¼ri YÃ¶netimi (Ã‡Ä±kar)</h3></div><div id="admin-jury-list" class="flex-1 overflow-y-auto space-y-2"></div></div>
                <div class="bg-slate-800 p-4 rounded-xl border border-slate-700 h-64 flex flex-col"><div class="flex justify-between items-center mb-2"><h3 class="text-sm font-bold text-cyan-400">Gelen Sorular (YansÄ±t)</h3></div><div id="admin-questions-list" class="flex-1 overflow-y-auto space-y-2"></div></div>
                <div class="bg-slate-800 p-4 rounded-xl border border-slate-700"><h3 class="text-sm font-bold text-slate-400 mb-3">AkÄ±ÅŸ KontrolÃ¼</h3><div class="grid grid-cols-2 gap-2 mb-4"><button onclick="setSpeaker('DavacÄ± AvukatÄ±')" class="p-2 bg-blue-900/50 border border-blue-700 rounded text-blue-100 text-xs">DavacÄ± Av.</button><button onclick="setSpeaker('SanÄ±k AvukatÄ±')" class="p-2 bg-red-900/50 border border-red-700 rounded text-red-100 text-xs">SanÄ±k Av.</button><button onclick="setSpeaker('SanÄ±k')" class="p-2 bg-red-900 border border-red-600 rounded text-white text-xs font-bold">SANIK</button><button onclick="setSpeaker('Hakim')" class="p-2 bg-yellow-600 rounded text-white text-xs font-bold">HAKÄ°M</button></div><div class="flex gap-2 border-t border-slate-600 pt-3"><div class="flex flex-1 gap-1"><button onclick="startTimer(1)" class="bg-slate-700 flex-1 rounded text-xs">1dk</button><button onclick="startTimer(3)" class="bg-slate-700 flex-1 rounded text-xs">3dk</button><button onclick="stopTimer()" class="bg-red-700 px-2 rounded"><i class="fa-solid fa-stop"></i></button></div><button onclick="toggleVoteVisibility()" class="bg-slate-700 px-2 rounded text-xs">Oylama</button></div>
                <button onclick="resetSimulation()" class="w-full mt-3 bg-red-900 p-3 rounded text-xs text-white border border-red-500 font-black shadow-lg hover:bg-red-800">âš ï¸ YENÄ° DAVA BAÅLAT</button></div>
                <div class="bg-slate-800 p-4 rounded-xl border border-slate-700 h-48 flex flex-col"><div class="flex justify-between items-center mb-2"><h3 class="text-sm font-bold text-slate-400">SÃ¶z HakkÄ± (<span id="req-count">0</span>)</h3></div><div id="admin-speak-list" class="flex-1 overflow-y-auto space-y-2"></div></div>
            </div>
        </div>
    </div>

    <!-- 4. AKILLI TAHTA MODU -->
    <div id="projector-panel" class="hidden absolute inset-0 bg-slate-900 text-white z-[150] overflow-hidden flex flex-col p-6 relative">
        <!-- BÄ°LDÄ°RÄ°M KATMANI (SESSÄ°ZLÄ°K, SORU VB.) -->
        <div id="projector-overlay" class="hidden absolute inset-0 z-[300] bg-black/90 flex flex-col items-center justify-center text-center p-10 animate-bounce">
            <i id="overlay-icon" class="text-6xl mb-4 text-white"></i>
            <h1 id="overlay-text" class="text-4xl font-black text-white tracking-widest uppercase"></h1>
        </div>

        <div id="notification-area" class="absolute top-24 right-6 w-96 z-[200] space-y-3 pointer-events-none"></div>
        <header class="flex justify-between items-center border-b border-slate-700 pb-4 mb-6">
            <div class="flex items-center gap-6"><div id="current-speaker-box" class="bg-slate-800 px-6 py-3 rounded-xl border-l-4 border-yellow-400 shadow-lg"><span class="text-[10px] text-slate-400 uppercase tracking-widest block mb-1">KÃœRSÃœDEKÄ° KONUÅMACI</span><h2 id="current-speaker-name" class="text-2xl font-bold text-white flex items-center gap-3"><i class="fa-solid fa-microphone-lines text-yellow-400 animate-pulse"></i><span id="speaker-text">Hakim</span></h2></div><div id="timer-box" class="hidden bg-slate-800 px-6 py-3 rounded-xl border-l-4 border-red-500 shadow-lg flex flex-col items-center justify-center w-32"><span class="text-[10px] text-slate-400 uppercase tracking-widest">SÃœRE</span><span id="timer-display" class="text-3xl font-mono font-bold text-red-400">00:00</span></div></div>
            <div class="text-right"><h1 class="text-3xl font-bold text-yellow-400 tracking-wider drop-shadow-[0_0_10px_rgba(250,204,21,0.5)]">ADALET SÄ°M.</h1><div class="text-xs text-slate-400 mt-1">JÃ¼ri: <span id="proj-jury-count" class="font-bold text-white">0/35</span></div></div>
        </header>
        <div class="flex-1 grid grid-cols-12 gap-6">
            <div class="col-span-7 flex flex-col gap-4">
                <div class="bg-slate-800 rounded-2xl p-6 border border-slate-700 shadow-xl h-full flex flex-col justify-center items-center">
                    <h2 class="text-lg font-bold text-slate-400 uppercase mb-8">Vicdani Kanaat</h2>
                    <div class="relative w-full h-12 bg-slate-700 rounded-full mb-4 overflow-hidden"><div class="absolute inset-0 bg-gradient-to-r from-red-600 via-slate-600 to-green-600 opacity-50"></div><div id="proj-sentiment-marker" class="absolute top-0 w-1 h-full bg-white shadow-lg transition-all duration-700 flex items-center justify-center" style="left: 50%;"><div id="proj-sentiment-val" class="absolute -top-8 bg-white text-slate-900 text-xs font-bold px-2 py-1 rounded">50%</div></div></div>
                    <div class="flex justify-between w-full font-bold px-2 mt-2"><span class="text-red-500">DAVACI</span><span class="text-green-500">SANIK</span></div>
                </div>
            </div>
            <div class="col-span-5 flex flex-col gap-4">
                <div class="bg-slate-800 rounded-2xl p-6 border border-slate-700 shadow-xl relative overflow-hidden h-1/3">
                    <h2 class="text-sm font-bold text-slate-400 uppercase mb-4 text-center">Oylama Durumu</h2>
                    <div id="vote-blind-overlay" class="absolute inset-0 z-10 bg-slate-800/95 flex flex-col items-center justify-center hidden"><i class="fa-solid fa-eye-slash text-4xl text-slate-600 mb-2"></i><h3 class="text-lg font-bold text-white">GÄ°ZLÄ°</h3></div>
                    <div id="vote-content" class="space-y-4 transition-all">
                        <div><div class="flex justify-between mb-1"><span class="text-sm font-bold text-red-500">SUÃ‡LU</span><span id="proj-vote-guilty" class="text-white font-bold text-sm">0</span></div><div class="h-6 bg-slate-700 rounded-full overflow-hidden border border-slate-600"><div id="proj-bar-guilty" class="h-full bg-red-600 transition-all duration-1000 shadow-[0_0_10px_red]" style="width: 0%"></div></div></div>
                        <div><div class="flex justify-between mb-1"><span class="text-sm font-bold text-green-500">SUÃ‡SUZ</span><span id="proj-vote-notguilty" class="text-white font-bold text-sm">0</span></div><div class="h-6 bg-slate-700 rounded-full overflow-hidden border border-slate-600"><div id="proj-bar-notguilty" class="h-full bg-green-600 transition-all duration-1000 shadow-[0_0_10px_green]" style="width: 0%"></div></div></div>
                    </div>
                    <div id="proj-final-verdict" class="mt-4 text-center text-2xl font-black tracking-widest hidden animate-pulse">KARAR: BEKLENÄ°YOR</div>
                </div>
                <div class="bg-slate-800 rounded-2xl border border-slate-700 h-1/3 flex flex-col overflow-hidden relative"><div class="bg-slate-700/50 p-2 border-b border-slate-600 flex justify-between items-center"><h2 class="text-xs font-bold text-yellow-400 uppercase pl-2">ğŸ’¬ MÃ¼zakere</h2></div><div id="proj-chat-feed" class="flex-1 p-4 space-y-3 overflow-y-auto flex flex-col-reverse"></div></div>
                <div class="bg-slate-800 rounded-2xl p-4 border border-slate-700 h-1/3 flex flex-col"><div class="flex justify-between items-center mb-2"><h3 class="text-xs font-bold text-slate-400 uppercase">YOKLAMA</h3></div><div class="flex-1 overflow-y-auto no-scrollbar pr-1"><div id="proj-seat-grid" class="grid grid-cols-7 gap-1.5 content-start"></div></div></div>
            </div>
        </div>
    </div>

    <!-- Modallar -->
    <div id="admin-login-modal" class="hidden fixed inset-0 z-[200] bg-black/90 flex items-center justify-center p-4"><form onsubmit="handleAdminLogin(event)" class="bg-slate-800 p-6 rounded-xl w-full max-w-sm border border-slate-700 relative"><h3 class="text-xl font-bold text-white mb-4" id="login-role-title">GiriÅŸ Yap</h3><input type="password" id="admin-pass" placeholder="Åifre" class="w-full p-3 bg-slate-900 border border-slate-600 rounded mb-4 text-white outline-none focus:border-blue-500"><div class="flex gap-2"><button type="button" onclick="document.getElementById('admin-login-modal').classList.add('hidden')" class="w-1/2 bg-slate-700 text-white py-2 rounded font-bold">Ä°ptal</button><button type="submit" class="w-1/2 bg-blue-600 text-white font-bold py-2 rounded">GiriÅŸ</button></div></form></div>
    <div id="image-modal" class="hidden fixed inset-0 z-[300] bg-black/95 flex items-center justify-center p-4" onclick="this.classList.add('hidden')"><img id="modal-img" src="" class="max-h-full max-w-full rounded"></div>
    <div id="video-modal" class="hidden fixed inset-0 z-[300] bg-black/95 flex items-center justify-center p-4" onclick="this.classList.add('hidden')"><video id="modal-video" controls class="max-h-full max-w-full rounded"><source src="olay_yeri.mp4" type="video/mp4"></video></div>
    <div id="student-quiz-modal" class="hidden fixed inset-0 z-[200] bg-slate-900/95 flex flex-col items-center justify-center p-6 quiz-enter text-white"><div class="w-full max-w-md bg-slate-800 p-6 rounded-2xl border border-slate-600"><div class="flex justify-between items-center mb-6"><span class="bg-red-600 px-3 py-1 rounded text-xs font-bold animate-pulse">CANLI SORU</span><span class="text-yellow-400 font-bold"><i class="fa-solid fa-clock mr-1"></i>Cevapla!</span></div><h2 id="quiz-question-text" class="text-xl font-bold text-center mb-6 leading-tight">...</h2><div id="quiz-options-container" class="grid grid-cols-1 gap-3 w-full"></div><p id="quiz-status-text" class="text-center mt-6 text-slate-400 text-sm hidden">CevabÄ±nÄ±z alÄ±ndÄ±.</p></div></div>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyB4afTGFkOqUjeVfqfHxgKCTbGHvftZIO4", authDomain: "mahkeme-sim.firebaseapp.com", projectId: "mahkeme-sim", storageBucket: "mahkeme-sim.firebasestorage.app", messagingSenderId: "573778878408", appId: "1:573778878408:web:67ab4ac006df3325ec6afd" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        const SEATS='sim_seats', VOTES='sim_votes', CHAT='sim_chat', SPEAK_REQ='sim_speak_requests', QUIZZES='sim_quizzes', SCORES='sim_scores', SETTINGS='sim_settings', NOTIFICATIONS='sim_notifications', QUESTIONS='sim_questions';
        let currentUser=null, loginRole='', quizChart=null, initialLoadComplete=false, tempSeatId=null, tempName=null, timerInterval=null;
        
        const neonColors = ['neon-text-pink', 'neon-text-cyan', 'neon-text-lime', 'neon-text-yellow', 'neon-text-purple'];
        function getNeonColor(name) { return neonColors[name.length % neonColors.length]; }
        const avatars = { m1: 'fa-solid fa-user-tie', m2: 'fa-solid fa-user-graduate', f1: 'fa-solid fa-user-nurse', f2: 'fa-solid fa-user-doctor' };

        document.addEventListener('DOMContentLoaded', () => {
            initSettings(); generateSeats('koltuk-grid', true); checkSession();
            if(document.getElementById('quizChart')) {
                const ctx = document.getElementById('quizChart').getContext('2d');
                quizChart = new Chart(ctx, { type: 'bar', data: { labels: ['A', 'B', 'C', 'D'], datasets: [{ label: 'Cevaplar', data: [0,0,0,0], backgroundColor: ['#ef4444', '#3b82f6', '#eab308', '#22c55e'] }] }, options: { scales: { y: { beginAtZero: true, ticks: { color: 'white' } }, x: { ticks: { color: 'white' } } }, plugins: { legend: { display: false } }, responsive: true, maintainAspectRatio: false } });
            }
        });

        async function initSettings() {
            const flow = await db.collection(SETTINGS).doc('flow').get();
            if(!flow.exists) db.collection(SETTINGS).doc('flow').set({current_speaker: 'Hakim', show_votes: true});
        }

        // --- GÄ°RÄ°Å VE AVATAR ---
        function generateSeats(elId, clickable) {
            const grid = document.getElementById(elId); if(!grid) return; grid.innerHTML = '';
            db.collection(SEATS).onSnapshot(snap => {
                const occupied = {}; snap.forEach(doc => occupied[doc.id] = doc.data().name);
                grid.innerHTML = '';
                for(let i=1; i<=35; i++) {
                    const div = document.createElement('div');
                    const isTaken = occupied[i];
                    if(clickable) {
                        const btn = document.createElement('button');
                        btn.className = `w-full aspect-square rounded-lg font-bold text-xs flex items-center justify-center border border-slate-700 transition ${isTaken ? 'bg-slate-800 text-slate-600 cursor-not-allowed' : 'bg-slate-700 hover:bg-yellow-500 hover:text-slate-900 text-slate-300'}`;
                        btn.textContent = i; if(!isTaken) btn.onclick = () => selectSeat(i); grid.appendChild(btn);
                    } else {
                        div.className = `w-full aspect-square rounded border flex items-center justify-center p-0.5 text-center relative overflow-hidden ${isTaken ? 'bg-green-600 border-green-400 shadow' : 'bg-slate-800 border-slate-700 opacity-40'}`;
                        div.innerHTML = isTaken ? `<span class="text-[7px] font-bold text-white leading-none break-words line-clamp-2">${occupied[i]}</span>` : `<span class="text-slate-600 text-[9px] font-mono">${i}</span>`;
                        grid.appendChild(div);
                    }
                }
                const countEl = document.getElementById('proj-jury-count'); if(countEl) countEl.textContent = `${Object.keys(occupied).length}/35`;
            });
        }

        function selectSeat(id) {
            const name = document.getElementById('juri-ad').value.trim();
            if(name.length < 3) return alert("LÃ¼tfen adÄ±nÄ±zÄ± giriniz.");
            tempSeatId = id; tempName = name;
            document.getElementById('avatar-modal').classList.remove('hidden');
        }

        let selectedAvatar = null;
        window.selectAvatar = function(avId) {
            selectedAvatar = avId;
            document.querySelectorAll('.avatar-option').forEach(el => el.classList.remove('selected'));
            document.getElementById('av-'+avId).classList.add('selected');
        }

        window.confirmSeatWithAvatar = async function() {
            if(!selectedAvatar) return alert("LÃ¼tfen bir avatar seÃ§in.");
            document.getElementById('avatar-modal').classList.add('hidden');
            await db.collection(SEATS).doc(String(tempSeatId)).set({
                name: tempName, seatId: tempSeatId, avatar: selectedAvatar, 
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
            await db.collection(SCORES).doc(String(tempSeatId)).set({val: 0});
            localStorage.setItem('seatId', tempSeatId); localStorage.setItem('name', tempName); localStorage.setItem('avatar', selectedAvatar);
            enterApp(tempName, tempSeatId);
        }

        function checkSession() { 
            const s = localStorage.getItem('seatId'); const n = localStorage.getItem('name'); 
            if(s && n) {
                db.collection(SEATS).doc(String(s)).get().then(doc => {
                    if(doc.exists) enterApp(n, s); else { localStorage.clear(); location.reload(); }
                });
            }
        }

        function enterApp(name, id) {
            currentUser = { name, seatId: id, avatar: localStorage.getItem('avatar') };
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('app-interface').classList.remove('hidden');
            document.getElementById('app-interface').classList.add('flex');
            document.getElementById('header-user-name').textContent = `${name} (${id})`;
            switchTab('tab-live', document.querySelector('.nav-item')); 
            initStudentListeners();
        }

        window.switchTab = function(tabId, btn) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(el => el.style.display = 'none');
            document.getElementById(tabId).style.display = 'flex';
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            if(btn) btn.classList.add('active');
        }

        // --- Ã–ÄRENCÄ° ---
        function initStudentListeners() {
            db.collection(SCORES).doc(String(currentUser.seatId)).onSnapshot(doc => { if(doc.exists) document.getElementById('my-score').textContent = doc.data().val; });
            db.collection(SEATS).doc(String(currentUser.seatId)).onSnapshot(doc => { if(!doc.exists && currentUser) { alert("Oturumunuz Hakim tarafÄ±ndan sonlandÄ±rÄ±ldÄ±."); logoutUser(); } });
            db.collection(QUIZZES).where('active', '==', true).onSnapshot(snap => {
                const modal = document.getElementById('student-quiz-modal');
                if(!snap.empty) {
                    const data = snap.docs[0].data();
                    document.getElementById('quiz-sound').play().catch(()=>{});
                    document.getElementById('quiz-question-text').textContent = data.question;
                    const opts = document.getElementById('quiz-options-container'); opts.innerHTML = '';
                    data.options.forEach((opt, idx) => {
                        const btn = document.createElement('button');
                        btn.className = "w-full p-4 bg-slate-800 hover:bg-yellow-500 hover:text-slate-900 rounded-xl border border-slate-600 text-left font-bold text-lg transition";
                        btn.textContent = opt; btn.onclick = () => submitAnswer(snap.docs[0].id, idx); opts.appendChild(btn);
                    });
                    modal.classList.remove('hidden');
                } else {
                    modal.classList.add('hidden'); document.getElementById('quiz-status-text').classList.add('hidden'); document.getElementById('quiz-options-container').classList.remove('hidden');
                }
            });
            document.getElementById('sentiment-slider').addEventListener('input', (e) => { setTimeout(() => db.collection('sim_sentiment').doc(String(currentUser.seatId)).set({val: parseInt(e.target.value), name: currentUser.name}), 300); });
            
            db.collection(CHAT).orderBy('timestamp','desc').limit(50).onSnapshot(s => {
                const f = document.getElementById('mobile-chat-feed'); f.innerHTML='';
                s.forEach(d => {
                    const data = d.data();
                    const isMe = data.seatId == currentUser.seatId;
                    const neonClass = getNeonColor(data.author);
                    const avIcon = avatars[data.avatar] || 'fa-solid fa-user';
                    const isTeacher = data.role === 'teacher';
                    const msgStyle = isTeacher ? 'vip-msg' : 'bg-slate-800/80 border border-slate-700';
                    const div = document.createElement('div');
                    div.className = `flex gap-2 mb-3 ${isMe ? 'flex-row-reverse' : ''}`;
                    div.innerHTML = `
                        <div onclick="openJurorCard('${data.seatId}', '${data.author}', '${data.avatar}')" class="w-8 h-8 rounded-full bg-slate-700 border border-slate-500 flex items-center justify-center flex-shrink-0 cursor-pointer"><i class="${avIcon} text-slate-300 text-xs"></i></div>
                        <div class="${msgStyle} p-2 rounded-xl max-w-[80%]">
                            <b class="${isTeacher ? 'text-yellow-400' : neonClass} text-[10px] block mb-0.5 cursor-pointer" onclick="openJurorCard('${data.seatId}', '${data.author}', '${data.avatar}')">${data.author}</b>
                            <span class="text-xs text-white">${data.text}</span>
                        </div>
                    `;
                    f.appendChild(div);
                });
            });
        }

        async function submitAnswer(quizId, optionIdx) {
            await db.collection('sim_answers').add({ quizId, optionIdx, seatId: currentUser.seatId, name: currentUser.name, timestamp: firebase.firestore.FieldValue.serverTimestamp() });
            const quizDoc = await db.collection(QUIZZES).doc(quizId).get();
            if(String(optionIdx) === String(quizDoc.data().correctOption)) {
                db.collection(SCORES).doc(String(currentUser.seatId)).update({ val: firebase.firestore.FieldValue.increment(10) });
                alert("DOÄRU! +10 PUAN");
            } else { alert("YanlÄ±ÅŸ Cevap."); }
            document.getElementById('quiz-options-container').classList.add('hidden'); document.getElementById('quiz-status-text').classList.remove('hidden');
        }

        window.requestSpeech = function() { if(!currentUser) return; if(confirm("SÃ¶z hakkÄ± iste?")) db.collection(SPEAK_REQ).add({author: currentUser.name, seatId: currentUser.seatId, timestamp: firebase.firestore.FieldValue.serverTimestamp()}); }
        window.sendChat = function() { 
            const txt = document.getElementById('chat-input').value; 
            if(txt) { db.collection(CHAT).add({text:txt, author:currentUser.name, seatId:currentUser.seatId, avatar: currentUser.avatar, timestamp: firebase.firestore.FieldValue.serverTimestamp()}); document.getElementById('chat-input').value=''; } 
        }
        window.submitVote = function(vote) { if(confirm("KararÄ±nÄ±z kesin mi?")) { db.collection(VOTES).doc(String(currentUser.seatId)).set({vote}); document.getElementById('vote-status').textContent = "Oyunuz: " + vote; } }
        window.sendQuestion = function() {
            const txt = document.getElementById('question-input').value.trim();
            if(!txt) return;
            db.collection(QUESTIONS).add({text: txt, author: currentUser.name, seat: currentUser.seatId, timestamp: firebase.firestore.FieldValue.serverTimestamp()});
            alert("Soru gÃ¶nderildi."); document.getElementById('question-input').value = '';
        }

        // --- YÃ–NETÄ°CÄ° ---
        window.openAdminLogin = function(role) { loginRole = role; document.getElementById('admin-login-modal').classList.remove('hidden'); }
        window.handleAdminLogin = function(e) {
            e.preventDefault(); const pass = document.getElementById('admin-pass').value;
            let isValid = (loginRole === 'teacher' && pass === 'admin') || (loginRole === 'judge' && pass === '1234');
            if(isValid) {
                document.getElementById('admin-login-modal').classList.add('hidden'); document.getElementById('login-screen').classList.add('hidden'); document.getElementById('admin-panel').classList.remove('hidden');
                if (loginRole === 'judge') { document.getElementById('btn-tab-teacher').classList.add('hidden'); document.getElementById('btn-tab-judge').classList.remove('hidden'); switchAdminTab('panel-judge'); initJudgePanel(); }
                else { document.getElementById('btn-tab-teacher').classList.remove('hidden'); document.getElementById('btn-tab-judge').classList.remove('hidden'); switchAdminTab('panel-teacher'); initTeacherPanel(); initJudgePanel(); }
            } else { alert("HatalÄ± Åifre!"); }
        }
        window.switchAdminTab = function(panelId) {
            document.getElementById('panel-teacher').classList.add('hidden'); document.getElementById('panel-judge').classList.add('hidden'); document.getElementById(panelId).classList.remove('hidden');
            document.querySelectorAll('.admin-tab-btn').forEach(btn => btn.classList.remove('text-yellow-400', 'border-yellow-400'));
            const activeBtn = panelId === 'panel-teacher' ? document.getElementById('btn-tab-teacher') : document.getElementById('btn-tab-judge');
            activeBtn.classList.add('text-yellow-400', 'border-yellow-400');
        }

        function initTeacherPanel() {
            db.collection(SEATS).onSnapshot(async (snap) => {
                const list = document.getElementById('teacher-attendance-list'); list.innerHTML = '';
                const scoreSnap = await db.collection(SCORES).get(); const scores = {}; scoreSnap.forEach(d => scores[d.id] = d.data().val);
                snap.forEach(doc => { const d = doc.data(); list.innerHTML += `<tr class="bg-slate-800 border-b border-slate-700"><td class="px-2 py-2">${d.seatId}</td><td class="px-2 py-2 font-bold text-white">${d.name}</td><td class="px-2 py-2 text-center text-yellow-400 font-mono">${scores[d.seatId] || 0}</td><td class="px-2 py-2 text-right"><button onclick="modScore('${d.seatId}', 5)" class="text-green-500 mr-2"><i class="fa-solid fa-plus"></i></button><button onclick="modScore('${d.seatId}', -5)" class="text-red-500"><i class="fa-solid fa-minus"></i></button></td></tr>`; });
            });
            db.collection(QUIZZES).where('active', '==', true).onSnapshot(snap => {
                if(!snap.empty && quizChart) {
                    db.collection('sim_answers').where('quizId', '==', snap.docs[0].id).onSnapshot(ansSnap => {
                        const counts = [0, 0, 0, 0]; ansSnap.forEach(d => { if(d.data().optionIdx >= 0) counts[d.data().optionIdx]++; });
                        quizChart.data.datasets[0].data = counts; quizChart.update();
                    });
                }
            });
        }
        window.modScore = function(seatId, amount) { db.collection(SCORES).doc(String(seatId)).update({ val: firebase.firestore.FieldValue.increment(amount) }); }
        window.publishQuiz = function() {
            const q = document.getElementById('quiz-q').value;
            const opts = [1,2,3,4].map(i => document.getElementById('quiz-opt'+i).value);
            const correct = document.getElementById('quiz-correct').value;
            if(!q || opts.some(x=>!x)) return alert("Eksik bilgi");
            db.collection(QUIZZES).where('active', '==', true).get().then(snap => { snap.forEach(d => d.ref.update({active: false})); }).then(() => {
                db.collection(QUIZZES).add({ question: q, options: opts, correctOption: correct, active: true, timestamp: firebase.firestore.FieldValue.serverTimestamp() });
                alert("Quiz YayÄ±nda!");
            });
        }
        window.closeQuiz = function() { db.collection(QUIZZES).where('active', '==', true).get().then(s => s.forEach(d => d.ref.update({active: false}))); alert("KapatÄ±ldÄ±"); }
        // Ã–ÄRETMEN SOHBETÄ°
        window.sendTeacherChat = function() {
            const txt = document.getElementById('teacher-chat-input').value;
            if(txt) { db.collection(CHAT).add({text:txt, author:'Ã–ÄRETMEN', seatId:'00', avatar:'m2', role:'teacher', timestamp: firebase.firestore.FieldValue.serverTimestamp()}); document.getElementById('teacher-chat-input').value=''; }
        }
        // Ã–ÄRETMEN ARAÃ‡LARI (YENÄ°)
        window.triggerClassEffect = function(type) {
            let msg = type === 'silence' ? 'SESSÄ°ZLÄ°K LÃœTFEN!' : (type === 'applause' ? 'HARÄ°KASINIZ!' : 'HERKESE +5 PUAN!');
            db.collection(NOTIFICATIONS).add({ text: msg, type: type, timestamp: firebase.firestore.FieldValue.serverTimestamp() });
            if(type === 'bonus') {
                db.collection(SCORES).get().then(snap => snap.forEach(d => d.ref.update({val: firebase.firestore.FieldValue.increment(5)})));
            }
        }

        function initJudgePanel() {
            db.collection(SPEAK_REQ).orderBy('timestamp', 'asc').onSnapshot(snap => {
                const list = document.getElementById('admin-speak-list'); document.getElementById('req-count').textContent = snap.size; list.innerHTML = '';
                snap.forEach(doc => { const d = doc.data(); list.innerHTML += `<div class="bg-slate-700 p-2 rounded flex justify-between items-center mb-2"><span class="text-sm">${d.author}</span><button onclick="approveSpeech('${doc.id}', '${d.author}')" class="bg-green-600 px-2 rounded text-xs">SÃ¶z Ver</button></div>`; });
            });
            db.collection(SEATS).onSnapshot(snap => {
                const list = document.getElementById('admin-jury-list'); list.innerHTML = '';
                snap.forEach(doc => { const d = doc.data(); list.innerHTML += `<div class="bg-slate-700 p-2 rounded flex justify-between items-center mb-1"><span class="text-xs text-white">${d.name} (${d.seatId})</span><button onclick="kickJuror('${d.seatId}')" class="bg-red-900 hover:bg-red-700 text-white px-2 py-1 rounded text-[10px] border border-red-500">Ã‡IKAR</button></div>`; });
            });
            db.collection(QUESTIONS).orderBy('timestamp', 'desc').onSnapshot(snap => {
                const list = document.getElementById('admin-questions-list'); list.innerHTML = '';
                snap.forEach(doc => { const d = doc.data(); list.innerHTML += `<div class="bg-slate-700 p-2 rounded mb-2 border-l-2 border-cyan-500"><div class="flex justify-between"><span class="text-xs text-yellow-400 font-bold">${d.author}</span><button onclick="broadcastQuestion('${d.text}')" class="text-[9px] bg-cyan-700 px-2 rounded hover:bg-cyan-600">YANSIT</button></div><p class="text-xs text-white mt-1">${d.text}</p></div>`; });
            });
        }
        window.broadcastQuestion = function(text) { db.collection(NOTIFICATIONS).add({ text: text, type: 'question', timestamp: firebase.firestore.FieldValue.serverTimestamp() }); alert("Soru tahtaya yansÄ±tÄ±ldÄ±."); }
        window.kickJuror = function(seatId) { if(confirm("AtÄ±lsÄ±n mÄ±?")) db.collection(SEATS).doc(String(seatId)).delete(); }
        window.approveSpeech = function(id, name) { db.collection(NOTIFICATIONS).add({ text: `${name} konuÅŸabilir.`, type: 'grant', timestamp: firebase.firestore.FieldValue.serverTimestamp() }); db.collection(SPEAK_REQ).doc(id).delete(); window.setSpeaker(name); }
        window.setSpeaker = function(name) { db.collection(SETTINGS).doc('flow').update({ current_speaker: name }); }
        window.toggleVoteVisibility = function() { db.collection(SETTINGS).doc('flow').get().then(d => db.collection(SETTINGS).doc('flow').update({ show_votes: !d.data().show_votes })); }
        window.startTimer = function(min) { const end = new Date(); end.setMinutes(end.getMinutes()+min); db.collection(SETTINGS).doc('flow').update({timer_end: firebase.firestore.Timestamp.fromDate(end)}); }
        window.stopTimer = function() { db.collection(SETTINGS).doc('flow').update({timer_end: null}); }

        // PROJECTOR
        window.openProjectorMode = function() { document.getElementById('login-screen').classList.add('hidden'); document.getElementById('projector-panel').classList.remove('hidden'); initProjectorData(); }
        function initProjectorData() {
            // Koltuklar
            const grid = document.getElementById('proj-seat-grid');
            db.collection(SEATS).onSnapshot(snap => {
                const occupied = {}; snap.forEach(doc => occupied[doc.id] = doc.data().name);
                grid.innerHTML = '';
                for(let i=1; i<=35; i++) {
                    const div = document.createElement('div');
                    const isTaken = occupied[i];
                    div.className = `w-full aspect-square rounded border flex items-center justify-center p-0.5 text-center relative overflow-hidden ${isTaken ? 'bg-green-600 border-green-400 shadow' : 'bg-slate-800 border-slate-700 opacity-40'}`;
                    div.innerHTML = isTaken ? `<span class="text-[7px] font-bold text-white leading-none break-words line-clamp-2">${occupied[i]}</span>` : `<span class="text-slate-600 text-[9px] font-mono">${i}</span>`;
                    grid.appendChild(div);
                }
                document.getElementById('proj-jury-count').textContent = `${Object.keys(occupied).length}/35`;
            });

            db.collection(SETTINGS).doc('flow').onSnapshot(doc => {
                if(doc.exists) {
                    const d = doc.data();
                    document.getElementById('speaker-text').textContent = d.current_speaker;
                    const overlay = document.getElementById('vote-blind-overlay'), content = document.getElementById('vote-content');
                    if(d.show_votes) { overlay.classList.add('hidden'); content.classList.remove('blur-overlay'); } else { overlay.classList.remove('hidden'); content.classList.add('blur-overlay'); }
                    const tb = document.getElementById('timer-box');
                    if(d.timer_end) {
                        tb.classList.remove('hidden');
                        if(timerInterval) clearInterval(timerInterval);
                        timerInterval = setInterval(() => {
                            const now = new Date().getTime(), distance = d.timer_end.toDate().getTime() - now;
                            if (distance < 0) { clearInterval(timerInterval); document.getElementById('timer-display').textContent = "00:00"; }
                            else { const m = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60)), s = Math.floor((distance % (1000 * 60)) / 1000); document.getElementById('timer-display').textContent = (m<10?"0"+m:m)+":"+(s<10?"0"+s:s); }
                        }, 1000);
                    } else { tb.classList.add('hidden'); if(timerInterval) clearInterval(timerInterval); }
                }
            });

            setTimeout(() => { initialLoadComplete = true; }, 2000);
            db.collection(NOTIFICATIONS).orderBy('timestamp', 'desc').limit(1).onSnapshot(snap => {
                if(!initialLoadComplete) return;
                snap.docChanges().forEach(change => { if(change.type === "added") { 
                    const d = change.doc.data(); 
                    if((new Date()-d.timestamp.toDate())<10000) { 
                        
                        const overlay = document.getElementById('projector-overlay');
                        const icon = document.getElementById('overlay-icon');
                        const text = document.getElementById('overlay-text');
                        
                        overlay.classList.remove('hidden');
                        text.textContent = d.text;

                        if(d.type === 'silence') { 
                            icon.className = 'fa-solid fa-bell-slash text-red-500 text-6xl'; 
                            document.getElementById('shh-sound').play(); 
                        } else if(d.type === 'applause') { 
                            icon.className = 'fa-solid fa-hands-clapping text-purple-500 text-6xl'; 
                            document.getElementById('applause-sound').play(); 
                            confetti({particleCount: 150, spread: 100});
                        } else if(d.type === 'question') {
                            icon.className = 'fa-solid fa-circle-question text-cyan-400 text-6xl';
                            document.getElementById('alert-sound').play();
                        } else {
                            icon.className = 'fa-solid fa-circle-info text-yellow-400 text-6xl';
                            document.getElementById('alert-sound').play();
                        }

                        setTimeout(() => { overlay.classList.add('hidden'); }, 4000);
                    } 
                } });
            });

            db.collection(CHAT).orderBy('timestamp','desc').limit(20).onSnapshot(s => {
                const f = document.getElementById('proj-chat-feed'); f.innerHTML='';
                s.forEach(d => {
                    const data = d.data();
                    const neonClass = getNeonColor(data.author);
                    const avIcon = avatars[data.avatar] || 'fa-solid fa-user';
                    const isTeacher = data.role === 'teacher';
                    const msgStyle = isTeacher ? 'vip-msg' : 'bg-slate-700/80 border-slate-500';
                    f.innerHTML += `<div class="${msgStyle} p-2 rounded mb-2 border-l-2 flex gap-2"><div class="w-6 h-6 rounded-full bg-slate-600 flex items-center justify-center"><i class="${isTeacher ? 'fa-solid fa-crown text-yellow-400' : avIcon} text-xs text-slate-300"></i></div><div><b class="${isTeacher ? 'text-yellow-400' : neonClass} text-xs block mb-1 font-black tracking-wide">${data.author}</b><span class="text-white text-sm leading-tight">${data.text}</span></div></div>`;
                });
            });

            db.collection('sim_sentiment').onSnapshot(s=>{ 
                let t=0, c=0; s.forEach(d=>{t+=d.data().val;c++}); 
                if(c>0) {
                    const avg = t/c;
                    document.getElementById('proj-sentiment-marker').style.left = avg+"%"; 
                    document.getElementById('proj-sentiment-val').textContent = avg.toFixed(0) + "%";
                }
            });
            db.collection(VOTES).onSnapshot(s => {
                let g=0, ng=0; s.forEach(d => d.data().vote === 'SUÃ‡LU' ? g++ : ng++);
                document.getElementById('proj-vote-guilty').textContent = g; document.getElementById('proj-vote-notguilty').textContent = ng;
                const t = g + ng; if(t > 0) { document.getElementById('proj-bar-guilty').style.width = (g/t*100) + "%"; document.getElementById('proj-bar-notguilty').style.width = (ng/t*100) + "%"; }
                const v = document.getElementById('proj-final-verdict'); if(g >= 18) { v.innerHTML="KARAR: <span class='text-red-500'>SUÃ‡LU</span>"; v.classList.remove('hidden'); } else if(ng >= 18) { v.innerHTML="KARAR: <span class='text-green-500'>SUÃ‡SUZ</span>"; v.classList.remove('hidden'); } else { v.classList.add('hidden'); }
            });
        }

        window.openJurorCard = async function(seatId, name, avatar) {
            const doc = await db.collection(SCORES).doc(String(seatId)).get();
            const score = doc.exists ? doc.data().val : 0;
            const avIcon = avatars[avatar] || 'fa-solid fa-user';
            document.getElementById('card-name').textContent = name; document.getElementById('card-seat').textContent = seatId; document.getElementById('card-score').textContent = score; document.getElementById('card-avatar').className = avIcon + " text-4xl text-white";
            document.getElementById('juror-card-modal').classList.remove('hidden');
        }

        window.resetSimulation = async function() {
            if(!confirm("TÃœM VERÄ°LER SÄ°LÄ°NECEK. ONAYLIYOR MUSUNUZ?")) return;
            const cols = [SEATS, VOTES, QUIZZES, SCORES, CHAT, SPEAK_REQ, NOTIFICATIONS, 'sim_answers', 'sim_sentiment', QUESTIONS];
            try {
                for (const col of cols) { const snap = await db.collection(col).get(); if (!snap.empty) { const batch = db.batch(); snap.docs.forEach(doc => batch.delete(doc.ref)); await batch.commit(); } }
                await db.collection(SETTINGS).doc('flow').set({current_speaker: 'Hakim', show_votes: true, timer_end: null});
                alert("Sistem SÄ±fÄ±rlandÄ±."); location.reload();
            } catch (error) { console.error(error); alert("Hata oluÅŸtu: " + error.message); }
        }

        window.openImage = function(src) { document.getElementById('modal-img').src=src; document.getElementById('image-modal').classList.remove('hidden'); }
        window.openVideoModal = function() { document.getElementById('video-modal').classList.remove('hidden'); }
        window.logoutUser = function() { 
            if(currentUser && currentUser.seatId) {
                db.collection(SEATS).doc(String(currentUser.seatId)).delete();
            }
            localStorage.clear(); location.reload(); 
        }
    </script>
</body>
</html>


