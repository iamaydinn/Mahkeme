<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Adalet SimÃ¼lasyonu v33.0</title>
    
    <!-- KÃ¼tÃ¼phaneler -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    
    <style>
        :root { --primary-navy: #0f172a; }
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #020617; 
            color: #f1f5f9;
            height: 100dvh; 
            width: 100vw;
            overflow: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        /* --- AKILLI TAHTA DÃœZENÄ° (GRID FIX) --- */
        .projector-grid-layout {
            display: grid;
            grid-template-columns: 60% 40%; /* Sol 60, SaÄŸ 40 */
            grid-template-rows: 1fr;
            gap: 1.5rem;
            height: calc(100vh - 100px); /* Header hariÃ§ alan */
            padding-bottom: 1rem;
        }
        
        .projector-col-right {
            display: grid;
            grid-template-rows: 60% 40%; /* Chat %60, Yoklama %40 */
            gap: 1.5rem;
            height: 100%;
            overflow: hidden;
        }

        /* --- NEON Ã‡ERÃ‡EVELER --- */
        .neon-box {
            background: rgba(30, 41, 59, 0.7);
            border: 2px solid rgba(6, 182, 212, 0.5);
            box-shadow: 0 0 15px rgba(6, 182, 212, 0.2);
            backdrop-filter: blur(10px);
        }
        .neon-box-alert {
            background: rgba(30, 41, 59, 0.95);
            border: 4px solid #facc15;
            box-shadow: 0 0 50px rgba(250, 204, 21, 0.5);
        }

        /* --- ANÄ°MASYONLAR --- */
        .btn-glow-teacher { box-shadow: 0 0 15px rgba(234, 179, 8, 0.4); border: 2px solid #facc15; animation: pulse-yellow 3s infinite; }
        @keyframes pulse-yellow { 50% { box-shadow: 0 0 25px rgba(234, 179, 8, 0.6); } }

        .btn-glow-judge { box-shadow: 0 0 15px rgba(59, 130, 246, 0.3); border: 2px solid #64748b; animation: pulse-blue 4s infinite; }
        @keyframes pulse-blue { 50% { box-shadow: 0 0 25px rgba(59, 130, 246, 0.5); } }

        .btn-glow-projector { box-shadow: 0 0 10px #06b6d4; border: 2px solid #22d3ee; animation: pulse-cyan 2s infinite alternate; }
        @keyframes pulse-cyan { from { box-shadow: 0 0 5px #06b6d4; } to { box-shadow: 0 0 20px #22d3ee; } }

        .nav-item.active { color: #fbbf24; border-top: 3px solid #fbbf24; background: rgba(30, 41, 59, 0.95); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .blur-overlay { filter: blur(12px); pointer-events: none; user-select: none; }
        
        .msg-enter { animation: slideLeft 0.4s ease-out; }
        @keyframes slideLeft { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: translateX(0); } }
        
        .zoom-in { animation: zoomIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes zoomIn { from { transform: scale(0); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* Renkler */
        .vip-msg { background: linear-gradient(90deg, rgba(66, 32, 6, 0.95), rgba(113, 63, 18, 0.95)); border: 2px solid #facc15; box-shadow: 0 0 15px rgba(250, 204, 21, 0.3); }
        .avatar-option.selected { border: 3px solid #fbbf24; box-shadow: 0 0 20px #fbbf24; transform: scale(1.1); }
        
        .neon-text-pink { color: #f472b6; text-shadow: 0 0 8px #be185d; }
        .neon-text-cyan { color: #22d3ee; text-shadow: 0 0 8px #0e7490; }
        .neon-text-lime { color: #a3e635; text-shadow: 0 0 8px #4d7c0f; }
        .neon-text-yellow { color: #facc15; text-shadow: 0 0 8px #b45309; }
    </style>
</head>
<body class="bg-slate-950 text-slate-100">

    <script src="https://www.gstatic.com/firebasejs/10.9.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.9.0/firebase-firestore-compat.js"></script>

    <!-- SESLER -->
    <audio id="alert-sound" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" preload="auto"></audio>
    <audio id="applause-sound" src="https://actions.google.com/sounds/v1/crowds/battle_crowd_celebrate_stutter.ogg" preload="auto"></audio>
    <audio id="shh-sound" src="https://www.soundjay.com/human/shh-01.mp3" preload="auto"></audio>
    <audio id="vote-sound" src="https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg" preload="auto"></audio>
    <audio id="quiz-sound" src="https://actions.google.com/sounds/v1/cartoon/cartoon_boing.ogg" preload="auto"></audio>

    <!-- TOAST BÄ°LDÄ°RÄ°MÄ° -->
    <div id="local-toast" class="fixed top-6 left-1/2 transform -translate-x-1/2 -translate-y-20 opacity-0 bg-slate-800/90 border border-green-500 text-white px-6 py-3 rounded-full shadow-[0_0_20px_rgba(34,197,94,0.4)] z-[9999] flex items-center gap-3 font-bold whitespace-nowrap transition-all duration-300 backdrop-blur-md">
        <i class="fa-solid fa-check-circle text-green-400"></i> <span id="toast-msg">Ä°ÅŸlem BaÅŸarÄ±lÄ±</span>
    </div>

    <!-- 1. GÄ°RÄ°Å EKRANI -->
    <div id="login-screen" class="absolute inset-0 z-[100] bg-slate-950 flex flex-col items-center justify-center p-4">
        <button onclick="document.getElementById('help-modal').classList.remove('hidden')" class="absolute top-6 right-6 w-10 h-10 rounded-full border border-purple-500 text-purple-400 flex items-center justify-center z-50 shadow-[0_0_15px_#a855f7] hover:scale-110 transition"><i class="fa-solid fa-question text-xl font-bold"></i></button>

        <div class="text-center w-full max-w-md mb-6 relative z-10">
            <div class="bg-white p-3 rounded-full mb-4 inline-block shadow-[0_0_30px_rgba(255,255,255,0.2)]"><img src="https://upload.wikimedia.org/wikipedia/tr/c/cc/Ataturkuni_logo.png?20200406213338" alt="Logo" class="w-20 h-20 object-contain"></div>
            <h2 class="text-[10px] font-bold text-slate-400 tracking-[0.3em] uppercase mb-1">ATATÃœRK ÃœNÄ°VERSÄ°TESÄ°</h2>
            <h3 class="text-xs text-yellow-400 font-bold tracking-widest border-b border-slate-800 pb-2 inline-block px-4 mb-2">SOSYAL BÄ°LGÄ°LER Ã–ÄRETMENLÄ°ÄÄ°</h3>
            <h1 class="text-4xl font-black tracking-widest text-white drop-shadow-lg">ADALET SÄ°M.</h1>
            <p class="text-slate-500 text-[10px] italic mt-2">HazÄ±rlayan: Muhammet Emin AydÄ±n</p>
        </div>

        <div class="w-full max-w-xs space-y-3 mb-4 z-10"><input type="text" id="juri-ad" placeholder="Ã–ÄŸrenci AdÄ± SoyadÄ±" class="w-full p-4 bg-slate-900/80 backdrop-blur rounded-xl border border-slate-700 text-white focus:border-yellow-500 outline-none text-center text-sm shadow-inner transition placeholder-slate-600"></div>
        <div class="w-full max-w-md flex-1 overflow-y-auto no-scrollbar bg-slate-900/50 p-4 rounded-xl border border-slate-800 mb-24 relative z-10 shadow-inner"><p class="text-center text-xs text-slate-400 mb-3 font-bold sticky top-0 bg-slate-900/95 py-2 z-20 border-b border-slate-800">KOLTUK SEÃ‡Ä°MÄ° ğŸ‘‡</p><div id="koltuk-grid" class="grid grid-cols-5 gap-3 pb-4"></div></div>

        <div class="fixed bottom-8 left-0 right-0 flex gap-4 w-full max-w-md mx-auto px-6 z-50 items-center">
            <button onclick="openAdminLogin('teacher')" class="flex-1 text-slate-900 font-black py-4 rounded-2xl transition flex items-center justify-center gap-2 text-xs bg-yellow-500 btn-glow-teacher active:scale-95"><i class="fa-solid fa-chalkboard-user text-xl"></i> Ã–ÄRETMEN</button>
            <button onclick="openAdminLogin('judge')" class="flex-1 text-white font-bold py-4 rounded-2xl transition flex items-center justify-center gap-2 text-xs bg-slate-700 btn-glow-judge active:scale-95"><i class="fa-solid fa-scale-balanced text-xl"></i> HAKÄ°M</button>
            <button onclick="openProjectorMode()" class="w-16 h-16 text-white rounded-2xl flex items-center justify-center bg-cyan-600 btn-glow-projector active:scale-95"><i class="fa-solid fa-tv text-2xl"></i></button>
        </div>
    </div>

    <!-- AVATAR MODAL -->
    <div id="avatar-modal" class="hidden fixed inset-0 z-[200] bg-slate-950 flex flex-col items-center justify-center p-6"><h2 class="text-2xl font-bold text-white mb-8 neon-text-purple">AVATARINI SEÃ‡</h2><div class="grid grid-cols-2 gap-6 mb-8"><div onclick="selectAvatar('m1')" class="avatar-option w-24 h-24 bg-blue-900/50 rounded-full border-2 border-blue-500 flex items-center justify-center cursor-pointer transition" id="av-m1"><i class="fa-solid fa-user-tie text-4xl text-blue-300"></i></div><div onclick="selectAvatar('m2')" class="avatar-option w-24 h-24 bg-blue-900/50 rounded-full border-2 border-blue-500 flex items-center justify-center cursor-pointer transition" id="av-m2"><i class="fa-solid fa-user-graduate text-4xl text-blue-300"></i></div><div onclick="selectAvatar('f1')" class="avatar-option w-24 h-24 bg-pink-900/50 rounded-full border-2 border-pink-500 flex items-center justify-center cursor-pointer transition" id="av-f1"><i class="fa-solid fa-user-nurse text-4xl text-pink-300"></i></div><div onclick="selectAvatar('f2')" class="avatar-option w-24 h-24 bg-pink-900/50 rounded-full border-2 border-pink-500 flex items-center justify-center cursor-pointer transition" id="av-f2"><i class="fa-solid fa-user-doctor text-4xl text-pink-300"></i></div></div><button onclick="confirmSeatWithAvatar()" class="bg-green-600 hover:bg-green-500 text-white px-8 py-3 rounded-xl font-bold shadow-lg transition transform active:scale-95">GÄ°RÄ°Å YAP</button></div>

    <!-- 2. Ã–ÄRENCÄ° ARAYÃœZÃœ -->
    <div id="app-interface" class="hidden absolute inset-0 z-10 flex flex-col bg-slate-100">
        <header class="bg-slate-900 text-white p-3 flex justify-between items-center shadow-lg h-16 flex-shrink-0 relative z-30">
            <div><span class="text-[9px] text-slate-400 uppercase tracking-wider block">Dosya No: 2025/456</span><span id="header-user-name" class="font-bold text-yellow-400 text-xs">JÃ¼ri Ãœyesi</span></div>
            <div class="flex items-center gap-3"><div class="bg-slate-800 px-3 py-1 rounded-full border border-yellow-500/30 flex items-center gap-1 shadow-[0_0_10px_rgba(250,204,21,0.3)]"><i class="fa-solid fa-star text-yellow-500 text-xs"></i><span id="my-score" class="text-xs font-bold text-white">0</span></div><button onclick="logoutUser()" class="text-slate-400 hover:text-red-400 p-2"><i class="fa-solid fa-right-from-bracket"></i></button></div>
        </header>

        <button onclick="requestSpeech()" class="fixed bottom-24 left-4 z-40 bg-yellow-500 text-slate-900 p-4 rounded-full shadow-[0_0_20px_rgba(250,204,21,0.6)] w-16 h-16 flex flex-col items-center justify-center border-4 border-white/20 active:scale-90 transition btn-glow-teacher"><i class="fa-solid fa-hand text-xl"></i><span class="text-[9px] font-bold mt-1">SÃ–Z</span></button>

        <!-- EMOJÄ° TEPKÄ°LERÄ° (SOL TARAF, SÃ–Z BUTONUNUN ÃœSTÃœNDE) -->
        <div class="fixed bottom-44 left-6 z-40 flex flex-col gap-3">
            <button onclick="sendReaction('ğŸ˜±')" class="w-12 h-12 bg-slate-800 rounded-full shadow-lg text-xl border border-slate-600 active:scale-90 transition hover:bg-slate-700 hover:border-yellow-500">ğŸ˜±</button>
            <button onclick="sendReaction('ğŸ¤”')" class="w-12 h-12 bg-slate-800 rounded-full shadow-lg text-xl border border-slate-600 active:scale-90 transition hover:bg-slate-700 hover:border-yellow-500">ğŸ¤”</button>
            <button onclick="sendReaction('ğŸ‘')" class="w-12 h-12 bg-slate-800 rounded-full shadow-lg text-xl border border-slate-600 active:scale-90 transition hover:bg-slate-700 hover:border-yellow-500">ğŸ‘</button>
        </div>

        <!-- GEREKÃ‡ELÄ° KARAR MODALI -->
        <div id="reason-modal" class="hidden fixed inset-0 z-[300] bg-slate-950/95 flex flex-col items-center justify-center p-6"><div class="bg-slate-800 w-full max-w-md p-6 rounded-2xl border border-slate-600 shadow-2xl"><h3 class="text-xl font-bold text-white mb-2 flex items-center gap-2"><i class="fa-solid fa-scale-unbalanced text-yellow-400"></i> Karar GerekÃ§eniz</h3><p class="text-slate-400 text-xs mb-4">Vicdani kanaatinizin sebebini kÄ±saca aÃ§Ä±klayÄ±nÄ±z. (+20 Puan)</p><textarea id="vote-reason" class="w-full bg-slate-900 border border-slate-700 rounded-xl p-3 text-white text-sm focus:outline-none focus:border-blue-500 mb-4 h-32 resize-none" placeholder="Ã‡Ã¼nkÃ¼..."></textarea><div class="flex gap-3"><button onclick="document.getElementById('reason-modal').classList.add('hidden')" class="flex-1 bg-slate-700 text-white py-3 rounded-xl text-sm font-bold hover:bg-slate-600">Ä°ptal</button><button onclick="confirmVote()" class="flex-1 bg-green-600 text-white py-3 rounded-xl text-sm font-bold hover:bg-green-500 shadow-lg">GÃ–NDER</button></div></div></div>
        
        <!-- QUIZ MODAL -->
        <div id="student-quiz-modal" class="hidden fixed inset-0 z-[300] bg-slate-950/95 flex flex-col items-center justify-center p-6 quiz-enter text-white"><div class="w-full max-w-md bg-slate-800 p-6 rounded-2xl border border-yellow-500/50 shadow-2xl"><div class="flex justify-between items-center mb-6"><span class="bg-red-600 px-3 py-1 rounded text-xs font-bold animate-pulse">CANLI SORU</span><span class="text-yellow-400 font-bold"><i class="fa-solid fa-clock mr-1"></i>Cevapla!</span></div><h2 id="quiz-question-text" class="text-xl font-bold text-center mb-6 leading-tight">...</h2><div id="quiz-options-container" class="grid grid-cols-1 gap-3 w-full"></div><p id="quiz-status-text" class="text-center mt-6 text-slate-400 text-sm hidden">CevabÄ±nÄ±z alÄ±ndÄ±.</p></div></div>

        <main class="flex-1 overflow-y-auto no-scrollbar relative w-full pb-20 bg-slate-200 text-slate-800">
            <div id="tab-live" class="tab-content active p-4 space-y-4">
                <div class="bg-white p-4 rounded-2xl shadow-md border-t-4 border-yellow-500 mb-2"><h3 class="font-bold text-slate-800 mb-3 text-center text-xs uppercase tracking-widest flex items-center justify-center gap-2"><i class="fa-solid fa-trophy text-yellow-500"></i> EN Ä°YÄ° 5 ADALET SAVAÅÃ‡ISI</h3><div id="leaderboard-list" class="space-y-2"><p class="text-center text-xs text-slate-400">YÃ¼kleniyor...</p></div></div>
                <div class="bg-white p-6 rounded-2xl shadow-lg border-l-4 border-blue-600"><h3 class="font-bold text-slate-800 mb-4 text-center text-sm">VÄ°CDANÄ° KANAAT</h3><input type="range" id="sentiment-slider" min="0" max="100" value="50" step="10" class="w-full h-4 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-blue-600"><div class="flex justify-between text-[10px] font-bold mt-2 px-1"><span class="text-red-600">DAVACI</span><span class="text-green-600">SANIK</span></div><p id="sentiment-status" class="text-center text-[10px] text-slate-400 mt-2 h-4"></p></div>
            </div>
            
            <div id="tab-evidence" class="tab-content hidden p-4 space-y-3">
                <div class="flex items-center justify-between border-b border-slate-300 pb-2 mb-2"><span class="text-xs font-black text-slate-600 uppercase">DELÄ°L DOSYASI</span><i class="fa-solid fa-folder-open text-yellow-500"></i></div>
                <div class="evidence-item rounded-xl p-4 flex items-center justify-between cursor-pointer bg-slate-800 text-white shadow-md border-l-4 border-red-500" onclick="openVideoModal()"><div class="flex items-center gap-4"><div class="w-10 h-10 rounded-full bg-red-900/50 flex items-center justify-center"><i class="fa-solid fa-video text-red-400"></i></div><div><h4 class="font-bold text-sm">Olay Yeri KaydÄ±</h4><p class="text-[10px] text-slate-400">Kriminal Ä°nceleme</p></div></div><i class="fa-solid fa-play text-slate-500"></i></div>
                <div class="evidence-item rounded-xl p-4 flex items-center justify-between cursor-pointer bg-white text-slate-800 shadow-sm border border-slate-200" onclick="openImage('WP1.png')"><div class="flex items-center gap-4"><div class="w-10 h-10 rounded-full bg-green-100 flex items-center justify-center"><i class="fa-brands fa-whatsapp text-green-600 text-xl"></i></div><div><h4 class="font-bold text-sm">YazÄ±ÅŸma KaydÄ± 1</h4><p class="text-[10px] text-slate-500">BaÅŸlangÄ±Ã§</p></div></div><i class="fa-solid fa-eye text-slate-300"></i></div>
                <div class="evidence-item rounded-xl p-4 flex items-center justify-between cursor-pointer bg-white text-slate-800 shadow-sm border border-slate-200" onclick="openImage('WP2.png')"><div class="flex items-center gap-4"><div class="w-10 h-10 rounded-full bg-red-100 flex items-center justify-center"><i class="fa-solid fa-triangle-exclamation text-red-600 text-xl"></i></div><div><h4 class="font-bold text-sm">YazÄ±ÅŸma KaydÄ± 2</h4><p class="text-[10px] text-slate-500">Tehdit</p></div></div><i class="fa-solid fa-eye text-slate-300"></i></div>
            </div>

            <div id="tab-chat" class="tab-content hidden flex-col h-full">
                <div id="mobile-chat-feed" class="flex-1 p-4 space-y-3 overflow-y-auto pb-20"></div>
                <div class="bg-white p-3 border-t flex gap-2 items-center safe-area-bottom sticky bottom-0 shadow-lg z-20"><input type="text" id="chat-input" class="flex-1 bg-slate-100 rounded-full px-4 py-3 text-sm outline-none border focus:border-blue-500" placeholder="Yaz..."><button onclick="sendChat()" class="bg-blue-600 text-white w-10 h-10 rounded-full shadow active:scale-90 transition"><i class="fa-solid fa-paper-plane"></i></button></div>
            </div>

            <div id="tab-comm" class="tab-content hidden p-4"><div class="bg-indigo-50 p-5 rounded-xl border border-indigo-100 shadow-sm"><h3 class="font-bold text-indigo-900 text-sm mb-3">Hakime Soru Ä°let</h3><textarea id="question-input" rows="4" class="w-full p-3 rounded-lg text-sm border border-indigo-200 focus:outline-none" placeholder="Sorunuz..."></textarea><button onclick="sendQuestion()" class="w-full mt-3 bg-indigo-600 text-white py-3 rounded-lg text-sm font-bold shadow-md active:scale-95 transition">GÃ–NDER</button></div></div>

            <div id="tab-vote" class="tab-content hidden p-6 flex-col justify-center space-y-6 h-full"><h2 class="text-center font-black text-2xl text-slate-800">KARAR VAKTÄ°</h2><button onclick="prepareVote('SUÃ‡LU')" class="w-full py-4 bg-red-600 text-white rounded-xl shadow-lg font-bold text-lg active:scale-95 transition border-b-4 border-red-800">SUÃ‡LU</button><button onclick="prepareVote('SUÃ‡SUZ')" class="w-full py-4 bg-green-600 text-white rounded-xl shadow-lg font-bold text-lg active:scale-95 transition border-b-4 border-green-800">SUÃ‡SUZ</button></div>
        </main>

        <nav class="bg-slate-900 border-t border-slate-800 flex justify-around pb-6 pt-3 h-20 shadow-[0_-5px_15px_rgba(0,0,0,0.3)] z-50 fixed bottom-0 left-0 right-0 w-full text-[10px] text-slate-400">
            <button onclick="switchTab('tab-live', this)" class="nav-item active flex flex-col items-center w-1/5 gap-1"><i class="fa-solid fa-tower-broadcast text-lg"></i>CanlÄ±</button>
            <button onclick="switchTab('tab-evidence', this)" class="nav-item flex flex-col items-center w-1/5 gap-1"><i class="fa-solid fa-folder-open text-lg"></i>KanÄ±t</button>
            <button onclick="switchTab('tab-chat', this)" class="nav-item flex flex-col items-center w-1/5 gap-1"><i class="fa-solid fa-comments text-lg"></i>Sohbet</button>
            <button onclick="switchTab('tab-comm', this)" class="nav-item flex flex-col items-center w-1/5 gap-1"><i class="fa-solid fa-question text-lg"></i>Soru</button>
            <button onclick="switchTab('tab-vote', this)" class="nav-item flex flex-col items-center w-1/5 gap-1"><i class="fa-solid fa-check-to-slot text-lg"></i>Karar</button>
        </nav>
    </div>

    <!-- 3. YÃ–NETÄ°CÄ° PANELÄ° -->
    <div id="admin-panel" class="hidden absolute inset-0 bg-slate-900 text-white z-[150] flex flex-col">
        <header class="flex justify-between items-center p-4 border-b border-slate-700 bg-slate-800"><h1 class="text-lg font-bold text-yellow-400" id="admin-title">YÃ–NETÄ°M</h1><button onclick="location.reload()" class="bg-red-900/50 px-3 py-1 rounded text-xs border border-red-800">Ã‡Ä±kÄ±ÅŸ</button></header>
        <div class="flex border-b border-slate-700 bg-slate-800 text-xs font-bold"><button onclick="switchAdminTab('panel-teacher')" class="flex-1 py-3 text-slate-400 border-b-2 border-transparent focus:text-yellow-400 focus:border-yellow-400 hidden" id="btn-tab-teacher">SINIF</button><button onclick="switchAdminTab('panel-judge')" class="flex-1 py-3 text-slate-400 border-b-2 border-transparent focus:text-yellow-400 focus:border-yellow-400" id="btn-tab-judge">DURUÅMA</button></div>
        <div class="flex-1 overflow-y-auto p-4 space-y-6">
            <!-- Ã–ÄŸretmen -->
            <div id="panel-teacher" class="hidden space-y-6">
                <div class="bg-slate-800 p-4 rounded-xl border border-slate-700"><h3 class="text-xs font-bold text-yellow-400 mb-2 uppercase tracking-widest">ğŸ‘‘ VIP Duyuru</h3><div class="flex gap-2"><input type="text" id="teacher-chat-input" placeholder="Mesaj..." class="flex-1 p-2 bg-slate-900 rounded border border-yellow-600/50 text-xs"><button onclick="sendTeacherChat()" class="bg-yellow-600 text-slate-900 font-bold px-4 rounded text-xs hover:bg-yellow-500">GÃ–NDER</button></div></div>
                <div class="bg-slate-800 p-4 rounded-xl border border-slate-700"><h3 class="text-xs font-bold text-blue-400 mb-2 uppercase tracking-widest">AraÃ§lar</h3><div class="grid grid-cols-2 gap-2"><button onclick="triggerClassEffect('silence')" class="bg-red-900/50 border border-red-600 text-red-200 p-3 rounded text-xs font-bold hover:bg-red-900"><i class="fa-solid fa-bell-slash mr-2"></i>SESSÄ°ZLÄ°K!</button><button onclick="triggerClassEffect('applause')" class="bg-purple-900/50 border border-purple-600 text-purple-200 p-3 rounded text-xs font-bold hover:bg-purple-900"><i class="fa-solid fa-hands-clapping mr-2"></i>ALKIÅLAT</button><button onclick="triggerClassEffect('bonus')" class="bg-green-900/50 border border-green-600 text-green-200 p-3 rounded text-xs font-bold col-span-2 hover:bg-green-900"><i class="fa-solid fa-star mr-2"></i>HERKESE +5 PUAN</button></div></div>
                <div class="bg-slate-800 p-4 rounded-xl border border-slate-700"><h3 class="text-xs font-bold text-green-400 mb-2">QUIZ</h3><input type="text" id="quiz-q" placeholder="Soru" class="w-full p-2 bg-slate-900 rounded border border-slate-600 mb-2 text-xs"><div class="grid grid-cols-2 gap-2 mb-2"><input type="text" id="quiz-opt1" placeholder="A" class="p-2 bg-slate-900 text-xs"><input type="text" id="quiz-opt2" placeholder="B" class="p-2 bg-slate-900 text-xs"><input type="text" id="quiz-opt3" placeholder="C" class="p-2 bg-slate-900 text-xs"><input type="text" id="quiz-opt4" placeholder="D" class="p-2 bg-slate-900 text-xs"></div><select id="quiz-correct" class="w-full p-2 bg-slate-900 text-xs mb-2 text-slate-400"><option value="">DoÄŸru Cevap</option><option value="0">A</option><option value="1">B</option><option value="2">C</option><option value="3">D</option></select><div class="flex gap-2"><button onclick="publishQuiz()" class="flex-1 bg-green-600 py-2 rounded text-xs font-bold">YAYINLA</button><button onclick="closeQuiz()" class="bg-red-600 px-4 py-2 rounded text-xs font-bold">BÄ°TÄ°R</button></div><div class="h-32 mt-4 w-full"><canvas id="quizChart"></canvas></div></div>
                <div class="bg-slate-800 p-4 rounded-xl border border-slate-700"><h3 class="text-sm font-bold text-yellow-400 uppercase mb-4">SÄ±nÄ±f Listesi</h3><div class="overflow-x-auto h-64 overflow-y-auto"><table class="w-full text-xs text-left text-slate-400"><tbody id="teacher-attendance-list" class="divide-y divide-slate-700"></tbody></table></div></div>
            </div>
            <!-- Hakim -->
            <div id="panel-judge" class="hidden space-y-6">
                <div class="bg-slate-800 p-4 rounded-xl border border-slate-700 h-64 flex flex-col"><div class="flex justify-between items-center mb-2"><h3 class="text-sm font-bold text-red-400">JÃ¼ri YÃ¶netimi (Ã‡Ä±kar)</h3></div><div id="admin-jury-list" class="flex-1 overflow-y-auto space-y-2"></div></div>
                <div class="bg-slate-800 p-4 rounded-xl border border-slate-700 h-64 flex flex-col"><div class="flex justify-between items-center mb-2"><h3 class="text-sm font-bold text-cyan-400">Gelen Sorular (YansÄ±t)</h3></div><div id="admin-questions-list" class="flex-1 overflow-y-auto space-y-2"></div></div>
                <div class="bg-slate-800 p-4 rounded-xl border border-slate-700"><h3 class="text-sm font-bold text-slate-400 mb-3">AkÄ±ÅŸ KontrolÃ¼</h3><div class="grid grid-cols-2 gap-2 mb-4"><button onclick="setSpeaker('DavacÄ± AvukatÄ±')" class="p-2 bg-blue-900/50 border border-blue-700 rounded text-blue-100 text-xs">DavacÄ± Av.</button><button onclick="setSpeaker('SanÄ±k AvukatÄ±')" class="p-2 bg-red-900/50 border border-red-700 rounded text-red-100 text-xs">SanÄ±k Av.</button><button onclick="setSpeaker('SanÄ±k')" class="p-2 bg-red-900 border border-red-600 rounded text-white text-xs font-bold">SANIK</button><button onclick="setSpeaker('DavacÄ±')" class="p-2 bg-blue-900 border border-blue-600 rounded text-white text-xs font-bold">DAVACI</button><button onclick="setSpeaker('TanÄ±k')" class="p-2 bg-purple-900 rounded text-white text-xs font-bold">TANIK</button><button onclick="setSpeaker('Hakim')" class="p-2 bg-yellow-600 rounded text-white text-xs font-bold">HAKÄ°M</button></div><div class="flex gap-2 border-t border-slate-600 pt-3"><div class="flex flex-1 gap-1"><button onclick="startTimer(1)" class="bg-slate-700 flex-1 rounded text-xs">1dk</button><button onclick="startTimer(3)" class="bg-slate-700 flex-1 rounded text-xs">3dk</button><button onclick="stopTimer()" class="bg-red-700 px-2 rounded"><i class="fa-solid fa-stop"></i></button></div><button onclick="toggleVoteVisibility()" class="bg-slate-700 px-2 rounded text-xs">Oylama</button></div><button onclick="resetSimulation()" class="w-full mt-3 bg-red-900 p-3 rounded text-xs text-white border border-red-500 font-black shadow-lg hover:bg-red-800">âš ï¸ YENÄ° DAVA BAÅLAT</button></div>
                <div class="bg-slate-800 p-4 rounded-xl border border-slate-700 h-48 flex flex-col"><div class="flex justify-between items-center mb-2"><h3 class="text-sm font-bold text-slate-400">SÃ¶z HakkÄ± (<span id="req-count">0</span>)</h3></div><div id="admin-speak-list" class="flex-1 overflow-y-auto space-y-2"></div></div>
            </div>
        </div>
    </div>

    <!-- 4. AKILLI TAHTA MODU -->
    <div id="projector-panel" class="hidden absolute inset-0 bg-slate-900 text-white z-[150] overflow-hidden flex flex-col p-6 relative">
        <!-- BÄ°LDÄ°RÄ°M OVERLAY -->
        <div id="projector-overlay" class="hidden absolute inset-0 z-[300] bg-black/90 flex flex-col items-center justify-center text-center p-10 zoom-in"><div class="neon-box-alert p-12 rounded-3xl w-full max-w-4xl"><i id="overlay-icon" class="text-8xl mb-6 text-white drop-shadow-lg block mx-auto"></i><h1 id="overlay-text" class="text-5xl font-black text-white tracking-widest uppercase drop-shadow-lg leading-tight"></h1></div></div>
        
        <div id="notification-area" class="absolute top-24 right-6 w-96 z-[200] space-y-3 pointer-events-none"></div>
        
        <!-- EMOJÄ°LER -->
        <div id="emoji-container" class="absolute inset-0 pointer-events-none z-[250] overflow-hidden"></div>

        <header class="flex justify-between items-center border-b border-slate-700 pb-4 mb-6 shrink-0">
            <div class="flex items-center gap-6"><div id="current-speaker-box" class="bg-slate-800 px-6 py-3 rounded-xl border-l-4 border-yellow-400 shadow-lg"><span class="text-[10px] text-slate-400 uppercase tracking-widest block mb-1">KÃœRSÃœDEKÄ° KONUÅMACI</span><h2 id="current-speaker-name" class="text-2xl font-bold text-white flex items-center gap-3"><i class="fa-solid fa-microphone-lines text-yellow-400 animate-pulse"></i><span id="speaker-text">Hakim</span></h2></div><div id="timer-box" class="hidden bg-slate-800 px-6 py-3 rounded-xl border-l-4 border-red-500 shadow-lg flex flex-col items-center justify-center w-32"><span class="text-[10px] text-slate-400 uppercase tracking-widest">SÃœRE</span><span id="timer-display" class="text-3xl font-mono font-bold text-red-400">00:00</span></div></div>
            <div class="text-right"><h1 class="text-3xl font-bold text-yellow-400 tracking-wider drop-shadow-[0_0_10px_rgba(250,204,21,0.5)]">ADALET SÄ°M.</h1><div class="text-xs text-slate-400 mt-1">JÃ¼ri: <span id="proj-jury-count" class="font-bold text-white">0/35</span></div></div>
        </header>
        
        <!-- Layout: Grid Fixed -->
        <div class="projector-grid-layout flex-1">
            <div class="flex flex-col gap-6 h-full">
                <div class="bg-slate-800 rounded-2xl p-6 border border-slate-700 shadow-xl flex flex-col justify-center items-center h-[40%] neon-box">
                    <h2 class="text-lg font-bold text-slate-400 uppercase mb-6">Vicdani Kanaat</h2>
                    <div class="relative w-full h-10 bg-slate-700 rounded-full mb-4 overflow-hidden"><div class="absolute inset-0 bg-gradient-to-r from-red-600 via-slate-600 to-green-600 opacity-50"></div><div id="proj-sentiment-marker" class="absolute top-0 w-1 h-full bg-white shadow-lg transition-all duration-700 flex items-center justify-center" style="left: 50%;"><div id="proj-sentiment-val" class="absolute -top-8 bg-white text-slate-900 text-xs font-bold px-2 py-1 rounded">50%</div></div></div>
                    <div class="flex justify-between w-full font-bold px-2 mt-2"><span class="text-red-500">DAVACI</span><span class="text-green-500">SANIK</span></div>
                </div>
                <div class="bg-slate-800 rounded-2xl p-6 border border-slate-700 shadow-xl relative overflow-hidden h-[60%] neon-box">
                    <h2 class="text-sm font-bold text-slate-400 uppercase mb-4 text-center">Oylama Durumu</h2>
                    <div id="vote-blind-overlay" class="absolute inset-0 z-10 bg-slate-800/95 flex flex-col items-center justify-center hidden"><i class="fa-solid fa-eye-slash text-4xl text-slate-600 mb-2"></i><h3 class="text-lg font-bold text-white">GÄ°ZLÄ°</h3></div>
                    <div id="vote-content" class="space-y-6 transition-all">
                        <div><div class="flex justify-between mb-1"><span class="text-sm font-bold text-red-500">SUÃ‡LU</span><span id="proj-vote-guilty" class="text-white font-bold text-sm">0</span></div><div class="h-8 bg-slate-700 rounded-full overflow-hidden border border-slate-600"><div id="proj-bar-guilty" class="h-full bg-red-600 transition-all duration-1000 shadow-[0_0_10px_red]" style="width: 0%"></div></div></div>
                        <div><div class="flex justify-between mb-1"><span class="text-sm font-bold text-green-500">SUÃ‡SUZ</span><span id="proj-vote-notguilty" class="text-white font-bold text-sm">0</span></div><div class="h-8 bg-slate-700 rounded-full overflow-hidden border border-slate-600"><div id="proj-bar-notguilty" class="h-full bg-green-600 transition-all duration-1000 shadow-[0_0_10px_green]" style="width: 0%"></div></div></div>
                    </div>
                    <div id="proj-final-verdict" class="mt-8 text-center text-4xl font-black tracking-widest hidden animate-pulse drop-shadow-lg">KARAR: BEKLENÄ°YOR</div>
                </div>
            </div>
            
            <div class="projector-col-right">
                <div class="bg-slate-800 rounded-2xl border border-slate-700 flex flex-col overflow-hidden relative neon-box"><div class="bg-slate-700/50 p-3 border-b border-slate-600 flex justify-between items-center"><h2 class="text-sm font-bold text-yellow-400 uppercase pl-2">ğŸ’¬ MÃ¼zakere AkÄ±ÅŸÄ±</h2></div><div id="proj-chat-feed" class="flex-1 p-4 space-y-3 overflow-y-auto flex flex-col-reverse"></div></div>
                <div class="bg-slate-800 rounded-2xl p-4 border border-slate-700 flex flex-col neon-box"><div class="flex justify-between items-center mb-2"><h3 class="text-xs font-bold text-slate-400 uppercase">YOKLAMA</h3></div><div class="flex-1 overflow-y-auto no-scrollbar pr-1"><div id="proj-seat-grid" class="grid grid-cols-7 gap-1.5 content-start"></div></div></div>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyB4afTGFkOqUjeVfqfHxgKCTbGHvftZIO4", authDomain: "mahkeme-sim.firebaseapp.com", projectId: "mahkeme-sim", storageBucket: "mahkeme-sim.firebasestorage.app", messagingSenderId: "573778878408", appId: "1:573778878408:web:67ab4ac006df3325ec6afd" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        const SEATS='sim_seats', VOTES='sim_votes', CHAT='sim_chat', SPEAK_REQ='sim_speak_requests', QUIZZES='sim_quizzes', SCORES='sim_scores', SETTINGS='sim_settings', NOTIFICATIONS='sim_notifications', QUESTIONS='sim_questions';
        let currentUser=null, loginRole='', quizChart=null, initialLoadComplete=false, tempSeatId=null, tempName=null, timerInterval=null, voteChoice=null;
        
        const neonColors = ['neon-text-pink', 'neon-text-cyan', 'neon-text-lime', 'neon-text-yellow', 'neon-text-purple'];
        function getNeonColor(name) { return neonColors[name.length % neonColors.length]; }
        const avatars = { m1: 'fa-solid fa-user-tie', m2: 'fa-solid fa-user-graduate', f1: 'fa-solid fa-user-nurse', f2: 'fa-solid fa-user-doctor' };

        document.addEventListener('DOMContentLoaded', () => {
            initSettings(); generateSeats('koltuk-grid', true); checkSession();
            if(document.getElementById('quizChart')) {
                const ctx = document.getElementById('quizChart').getContext('2d');
                quizChart = new Chart(ctx, { type: 'bar', data: { labels: ['A', 'B', 'C', 'D'], datasets: [{ label: 'Cevaplar', data: [0,0,0,0], backgroundColor: ['#ef4444', '#3b82f6', '#eab308', '#22c55e'] }] }, options: { scales: { y: { beginAtZero: true, ticks: { color: 'white' } }, x: { ticks: { color: 'white' } } }, plugins: { legend: { display: false } }, responsive: true, maintainAspectRatio: false } });
            }
        });

        async function initSettings() {
            const flow = await db.collection(SETTINGS).doc('flow').get();
            if(!flow.exists) db.collection(SETTINGS).doc('flow').set({current_speaker: 'Hakim', show_votes: true});
        }

        // --- GÄ°RÄ°Å VE AVATAR ---
        function generateSeats(elId, clickable) {
            const grid = document.getElementById(elId); if(!grid) return; grid.innerHTML = '';
            db.collection(SEATS).onSnapshot(snap => {
                const occupied = {}; snap.forEach(doc => occupied[doc.id] = doc.data().name);
                grid.innerHTML = '';
                for(let i=1; i<=35; i++) {
                    const div = document.createElement('div');
                    const isTaken = occupied[i];
                    if(clickable) {
                        const btn = document.createElement('button');
                        btn.className = `w-full aspect-square rounded-lg font-bold text-xs flex items-center justify-center border border-slate-700 transition ${isTaken ? 'bg-red-600 text-white cursor-not-allowed seat-occupied' : 'bg-slate-700 hover:bg-yellow-500 hover:text-slate-900 text-slate-300 seat-empty'}`;
                        btn.textContent = i; if(!isTaken) btn.onclick = () => selectSeat(i); grid.appendChild(btn);
                    } else {
                        div.className = `w-full aspect-square rounded border flex items-center justify-center p-0.5 text-center relative overflow-hidden ${isTaken ? 'bg-green-600 border-green-400 shadow' : 'bg-slate-800 border-slate-700 opacity-40'}`;
                        div.innerHTML = isTaken ? `<span class="text-[7px] font-bold text-white leading-none break-words line-clamp-2">${occupied[i]}</span>` : `<span class="text-slate-600 text-[9px] font-mono">${i}</span>`;
                        grid.appendChild(div);
                    }
                }
                const countEl = document.getElementById('proj-jury-count'); if(countEl) countEl.textContent = `${Object.keys(occupied).length}/35`;
            });
        }

        function selectSeat(id) {
            const name = document.getElementById('juri-ad').value.trim();
            if(name.length < 3) return alert("LÃ¼tfen adÄ±nÄ±zÄ± giriniz.");
            tempSeatId = id; tempName = name;
            document.getElementById('avatar-modal').classList.remove('hidden');
        }

        let selectedAvatar = null;
        window.selectAvatar = function(avId) {
            selectedAvatar = avId;
            document.querySelectorAll('.avatar-option').forEach(el => el.classList.remove('selected'));
            document.getElementById('av-'+avId).classList.add('selected');
        }

        window.confirmSeatWithAvatar = async function() {
            if(!selectedAvatar) return alert("LÃ¼tfen bir avatar seÃ§in.");
            document.getElementById('avatar-modal').classList.add('hidden');
            await db.collection(SEATS).doc(String(tempSeatId)).set({
                name: tempName, seatId: tempSeatId, avatar: selectedAvatar, 
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
            await db.collection(SCORES).doc(String(tempSeatId)).set({val: 0, name: tempName, avatar: selectedAvatar});
            localStorage.setItem('seatId', tempSeatId); localStorage.setItem('name', tempName); localStorage.setItem('avatar', selectedAvatar);
            enterApp(tempName, tempSeatId);
        }

        function checkSession() { 
            const s = localStorage.getItem('seatId'); const n = localStorage.getItem('name'); 
            if(s && n) {
                db.collection(SEATS).doc(String(s)).get().then(doc => {
                    if(doc.exists) enterApp(n, s); else { localStorage.clear(); location.reload(); }
                });
            }
        }

        function enterApp(name, id) {
            currentUser = { name, seatId: id, avatar: localStorage.getItem('avatar') };
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('app-interface').classList.remove('hidden');
            document.getElementById('app-interface').classList.add('flex');
            document.getElementById('header-user-name').textContent = `${name} (${id})`;
            switchTab('tab-live', document.querySelector('.nav-item')); 
            initStudentListeners();
        }

        window.switchTab = function(tabId, btn) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(el => el.style.display = 'none');
            document.getElementById(tabId).style.display = 'flex';
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            if(btn) btn.classList.add('active');
        }

        function showLocalToast(msg) {
            const t = document.getElementById('local-toast');
            document.getElementById('toast-msg').textContent = msg;
            t.classList.remove('hidden'); t.classList.add('toast-show');
            setTimeout(() => { t.classList.remove('toast-show'); setTimeout(() => t.classList.add('hidden'), 300); }, 2000);
        }

        // --- Ã–ÄRENCÄ° ---
        function initStudentListeners() {
            db.collection(SCORES).doc(String(currentUser.seatId)).onSnapshot(doc => { if(doc.exists) document.getElementById('my-score').textContent = doc.data().val; });
            db.collection(SEATS).doc(String(currentUser.seatId)).onSnapshot(doc => { if(!doc.exists && currentUser) { alert("Oturumunuz Hakim tarafÄ±ndan sonlandÄ±rÄ±ldÄ±."); logoutUser(); } });
            
            // LÄ°DERLÄ°K TABLOSU
            db.collection(SCORES).orderBy('val', 'desc').limit(5).onSnapshot(snap => {
                const list = document.getElementById('leaderboard-list'); 
                if(list) {
                    list.innerHTML = ''; let rank = 1;
                    snap.forEach(doc => {
                        const d = doc.data();
                        const style = rank === 1 ? 'rank-1' : (rank === 2 ? 'rank-2' : (rank === 3 ? 'rank-3' : 'border-slate-700'));
                        const icon = rank === 1 ? '<i class="fa-solid fa-crown text-yellow-400"></i>' : `<span class="font-mono text-slate-500">#${rank}</span>`;
                        list.innerHTML += `<div class="border ${style} p-2 rounded-lg flex justify-between items-center bg-slate-800/50 rank-card"><div class="flex items-center gap-2">${icon}<span class="text-xs font-bold text-white">${d.name}</span></div><span class="text-xs font-mono text-yellow-400">${d.val} P</span></div>`;
                        rank++;
                    });
                }
            });

            db.collection(QUIZZES).where('active', '==', true).onSnapshot(snap => {
                const modal = document.getElementById('student-quiz-modal');
                if(!snap.empty) {
                    const data = snap.docs[0].data();
                    document.getElementById('quiz-sound').play().catch(()=>{});
                    document.getElementById('quiz-question-text').textContent = data.question;
                    const opts = document.getElementById('quiz-options-container'); opts.innerHTML = '';
                    data.options.forEach((opt, idx) => {
                        const btn = document.createElement('button');
                        btn.className = "w-full p-4 bg-slate-800 hover:bg-yellow-500 hover:text-slate-900 rounded-xl border border-slate-600 text-left font-bold text-lg transition";
                        btn.textContent = opt; btn.onclick = () => submitAnswer(snap.docs[0].id, idx); opts.appendChild(btn);
                    });
                    modal.classList.remove('hidden'); modal.style.zIndex = "9999";
                } else {
                    modal.classList.add('hidden'); document.getElementById('quiz-status-text').classList.add('hidden'); document.getElementById('quiz-options-container').classList.remove('hidden');
                }
            });
            document.getElementById('sentiment-slider').addEventListener('input', (e) => { setTimeout(() => db.collection('sim_sentiment').doc(String(currentUser.seatId)).set({val: parseInt(e.target.value), name: currentUser.name}), 300); });
            
            db.collection(CHAT).orderBy('timestamp','desc').limit(50).onSnapshot(s => {
                const f = document.getElementById('mobile-chat-feed'); f.innerHTML='';
                s.forEach(d => {
                    const data = d.data();
                    const isMe = data.seatId == currentUser.seatId;
                    const neonClass = getNeonColor(data.author);
                    const avIcon = avatars[data.avatar] || 'fa-solid fa-user';
                    const isTeacher = data.role === 'teacher';
                    const msgStyle = isTeacher ? 'vip-msg' : 'bg-slate-800/80 border border-slate-700';
                    const div = document.createElement('div');
                    div.className = `flex gap-2 mb-3 ${isMe ? 'flex-row-reverse' : ''}`;
                    div.innerHTML = `
                        <div onclick="openJurorCard('${data.seatId}', '${data.author}', '${data.avatar}')" class="w-8 h-8 rounded-full ${isTeacher ? 'bg-yellow-900' : 'bg-slate-700'} border border-slate-500 flex items-center justify-center flex-shrink-0 cursor-pointer"><i class="${isTeacher ? 'fa-solid fa-crown text-yellow-400' : avIcon + ' text-slate-300'} text-xs"></i></div>
                        <div class="${msgStyle} p-2 rounded-xl max-w-[80%]">
                            <b class="${isTeacher ? 'text-yellow-400' : neonClass} text-[10px] block mb-0.5 cursor-pointer" onclick="openJurorCard('${data.seatId}', '${data.author}', '${data.avatar}')">${data.author}</b>
                            <span class="text-xs text-white">${data.text}</span>
                        </div>
                    `;
                    f.appendChild(div);
                });
            });
        }

        async function submitAnswer(quizId, optionIdx) {
            await db.collection('sim_answers').add({ quizId, optionIdx, seatId: currentUser.seatId, name: currentUser.name, timestamp: firebase.firestore.FieldValue.serverTimestamp() });
            const quizDoc = await db.collection(QUIZZES).doc(quizId).get();
            if(String(optionIdx) === String(quizDoc.data().correctOption)) {
                db.collection(SCORES).doc(String(currentUser.seatId)).update({ val: firebase.firestore.FieldValue.increment(10) });
                showLocalToast("DOÄRU! +10 PUAN");
            } else { showLocalToast("YanlÄ±ÅŸ Cevap."); }
            document.getElementById('quiz-options-container').classList.add('hidden'); document.getElementById('quiz-status-text').classList.remove('hidden');
        }

        window.requestSpeech = function() { if(!currentUser) return; if(confirm("SÃ¶z hakkÄ± iste?")) { db.collection(SPEAK_REQ).add({author: currentUser.name, seatId: currentUser.seatId, timestamp: firebase.firestore.FieldValue.serverTimestamp()}); showLocalToast("Talep Ä°letildi"); } }
        window.sendChat = function() { 
            const txt = document.getElementById('chat-input').value; 
            if(txt) { db.collection(CHAT).add({text:txt, author:currentUser.name, seatId:currentUser.seatId, avatar: currentUser.avatar, timestamp: firebase.firestore.FieldValue.serverTimestamp()}); document.getElementById('chat-input').value=''; } 
        }
        
        // GEREKÃ‡ELÄ° KARAR
        window.prepareVote = function(choice) {
            voteChoice = choice;
            document.getElementById('reason-modal').classList.remove('hidden');
        }
        window.closeReasonModal = function() { document.getElementById('reason-modal').classList.add('hidden'); }
        window.confirmVote = async function() {
            const reason = document.getElementById('vote-reason').value;
            if(!reason) return alert("LÃ¼tfen bir gerekÃ§e yazÄ±nÄ±z.");
            await db.collection(VOTES).doc(String(currentUser.seatId)).set({
                vote: voteChoice, reason: reason, name: currentUser.name,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
            db.collection(SCORES).doc(String(currentUser.seatId)).update({ val: firebase.firestore.FieldValue.increment(20) });
            document.getElementById('vote-sound').play();
            showLocalToast("OYUNUZ ALINDI!");
            document.getElementById('reason-modal').classList.add('hidden');
            document.getElementById('vote-status').textContent = "Oyunuz: " + voteChoice;
        }
        
        window.sendQuestion = function() {
            const txt = document.getElementById('question-input').value.trim();
            if(!txt) return;
            db.collection(QUESTIONS).add({text: txt, author: currentUser.name, seat: currentUser.seatId, timestamp: firebase.firestore.FieldValue.serverTimestamp()});
            showLocalToast("Soru GÃ¶nderildi"); document.getElementById('question-input').value = '';
        }

        // --- YÃ–NETÄ°CÄ° ---
        window.openAdminLogin = function(role) { loginRole = role; document.getElementById('admin-login-modal').classList.remove('hidden'); }
        window.handleAdminLogin = function(e) {
            e.preventDefault(); const pass = document.getElementById('admin-pass').value;
            let isValid = (loginRole === 'teacher' && pass === 'admin') || (loginRole === 'judge' && pass === '1234');
            if(isValid) {
                document.getElementById('admin-login-modal').classList.add('hidden'); document.getElementById('login-screen').classList.add('hidden'); document.getElementById('admin-panel').classList.remove('hidden');
                if (loginRole === 'judge') { document.getElementById('btn-tab-teacher').classList.add('hidden'); document.getElementById('btn-tab-judge').classList.remove('hidden'); switchAdminTab('panel-judge'); initJudgePanel(); }
                else { document.getElementById('btn-tab-teacher').classList.remove('hidden'); document.getElementById('btn-tab-judge').classList.remove('hidden'); switchAdminTab('panel-teacher'); initTeacherPanel(); initJudgePanel(); }
            } else { alert("HatalÄ± Åifre!"); }
        }
        window.switchAdminTab = function(panelId) {
            document.getElementById('panel-teacher').classList.add('hidden'); document.getElementById('panel-judge').classList.add('hidden'); document.getElementById(panelId).classList.remove('hidden');
            document.querySelectorAll('.admin-tab-btn').forEach(btn => btn.classList.remove('text-yellow-400', 'border-yellow-400'));
            const activeBtn = panelId === 'panel-teacher' ? document.getElementById('btn-tab-teacher') : document.getElementById('btn-tab-judge');
            activeBtn.classList.add('text-yellow-400', 'border-yellow-400');
        }

        function initTeacherPanel() {
            db.collection(SEATS).onSnapshot(async (snap) => {
                const list = document.getElementById('teacher-attendance-list'); list.innerHTML = '';
                const scoreSnap = await db.collection(SCORES).get();
                const votesSnap = await db.collection(VOTES).get();
                
                const scores = {}; scoreSnap.forEach(d => scores[d.id] = d.data().val);
                const votes = {}; votesSnap.forEach(d => votes[d.id] = d.data());

                snap.forEach(doc => {
                    const d = doc.data();
                    const voteData = votes[d.seatId] || { vote: '-', reason: '' };
                    list.innerHTML += `
                        <tr class="bg-slate-800 border-b border-slate-700 hover:bg-slate-700">
                            <td class="p-2 font-mono text-slate-400">${d.seatId}</td>
                            <td class="p-2 font-bold text-white">${d.name}</td>
                            <td class="p-2 text-center text-yellow-400 font-mono font-bold">${scores[d.seatId] || 0}</td>
                            <td class="p-2 text-center"><span class="px-2 py-0.5 rounded text-[10px] font-bold ${voteData.vote==='SUÃ‡LU'?'bg-red-900 text-red-200':(voteData.vote==='SUÃ‡SUZ'?'bg-green-900 text-green-200':'bg-slate-600')}">${voteData.vote}</span></td>
                            <td class="p-2 text-xs text-slate-300 italic max-w-xs truncate" title="${voteData.reason}">${voteData.reason}</td>
                        </tr>`;
                });
            });
            db.collection(QUIZZES).where('active', '==', true).onSnapshot(snap => {
                if(!snap.empty && quizChart) {
                    db.collection('sim_answers').where('quizId', '==', snap.docs[0].id).onSnapshot(ansSnap => {
                        const counts = [0, 0, 0, 0]; ansSnap.forEach(d => { if(d.data().optionIdx >= 0) counts[d.data().optionIdx]++; });
                        quizChart.data.datasets[0].data = counts; quizChart.update();
                    });
                }
            });
        }
        window.modScore = function(seatId, amount) { db.collection(SCORES).doc(String(seatId)).update({ val: firebase.firestore.FieldValue.increment(amount) }); showLocalToast("Puan GÃ¼ncellendi"); }
        window.publishQuiz = function() {
            const q = document.getElementById('quiz-q').value;
            const opts = [1,2,3,4].map(i => document.getElementById('quiz-opt'+i).value);
            const correct = document.getElementById('quiz-correct').value;
            if(!q || opts.some(x=>!x)) return alert("Eksik bilgi");
            db.collection(QUIZZES).where('active', '==', true).get().then(snap => { snap.forEach(d => d.ref.update({active: false})); }).then(() => {
                db.collection(QUIZZES).add({ question: q, options: opts, correctOption: correct, active: true, timestamp: firebase.firestore.FieldValue.serverTimestamp() });
                showLocalToast("Quiz YayÄ±nda!");
            });
        }
        window.closeQuiz = function() { db.collection(QUIZZES).where('active', '==', true).get().then(s => s.forEach(d => d.ref.update({active: false}))); alert("KapatÄ±ldÄ±"); }
        // Ã–ÄRETMEN SOHBETÄ°
        window.sendTeacherChat = function() {
            const txt = document.getElementById('teacher-chat-input').value;
            if(txt) { db.collection(CHAT).add({text:txt, author:'Ã–ÄRETMEN', seatId:'00', avatar:'m2', role:'teacher', timestamp: firebase.firestore.FieldValue.serverTimestamp()}); document.getElementById('teacher-chat-input').value=''; }
        }
        // Ã–ÄRETMEN ARAÃ‡LARI
        window.triggerClassEffect = function(type) {
            let msg = type === 'silence' ? 'SESSÄ°ZLÄ°K LÃœTFEN!' : (type === 'applause' ? 'HARÄ°KASINIZ!' : 'HERKESE +5 PUAN!');
            db.collection(NOTIFICATIONS).add({ text: msg, type: type, timestamp: firebase.firestore.FieldValue.serverTimestamp() });
            if(type === 'bonus') {
                db.collection(SCORES).get().then(snap => snap.forEach(d => d.ref.update({val: firebase.firestore.FieldValue.increment(5)})));
            }
        }
        // YENÄ°: EMOJÄ° REAKSÄ°YON
        window.sendReaction = function(emoji) {
            db.collection(NOTIFICATIONS).add({ text: emoji, type: 'reaction', timestamp: firebase.firestore.FieldValue.serverTimestamp() });
            showLocalToast(emoji + " GÃ¶nderildi");
        }

        function initJudgePanel() {
            db.collection(SPEAK_REQ).orderBy('timestamp', 'asc').onSnapshot(snap => {
                const list = document.getElementById('admin-speak-list'); document.getElementById('req-count').textContent = snap.size; list.innerHTML = '';
                snap.forEach(doc => { const d = doc.data(); list.innerHTML += `<div class="bg-slate-700 p-2 rounded flex justify-between items-center mb-2"><span class="text-sm">${d.author}</span><button onclick="approveSpeech('${doc.id}', '${d.author}')" class="bg-green-600 px-2 rounded text-xs">SÃ¶z Ver</button></div>`; });
            });
            db.collection(SEATS).onSnapshot(snap => {
                const list = document.getElementById('admin-jury-list'); list.innerHTML = '';
                snap.forEach(doc => { const d = doc.data(); list.innerHTML += `<div class="bg-slate-700 p-2 rounded flex justify-between items-center mb-1"><span class="text-xs text-white">${d.name} (${d.seatId})</span><button onclick="kickJuror('${d.seatId}')" class="bg-red-900 hover:bg-red-700 text-white px-2 py-1 rounded text-[10px] border border-red-500">Ã‡IKAR</button></div>`; });
            });
            db.collection(QUESTIONS).orderBy('timestamp', 'desc').onSnapshot(snap => {
                const list = document.getElementById('admin-questions-list'); list.innerHTML = '';
                snap.forEach(doc => { const d = doc.data(); list.innerHTML += `<div class="bg-slate-700 p-2 rounded mb-2 border-l-2 border-cyan-500"><div class="flex justify-between"><span class="text-xs text-yellow-400 font-bold">${d.author}</span><button onclick="broadcastQuestion('${d.text}')" class="text-[9px] bg-cyan-700 px-2 rounded hover:bg-cyan-600">YANSIT</button></div><p class="text-xs text-white mt-1">${d.text}</p></div>`; });
            });
        }
        window.broadcastQuestion = function(text) { db.collection(NOTIFICATIONS).add({ text: text, type: 'question', timestamp: firebase.firestore.FieldValue.serverTimestamp() }); alert("Soru tahtaya yansÄ±tÄ±ldÄ±."); }
        window.kickJuror = function(seatId) { if(confirm("AtÄ±lsÄ±n mÄ±?")) db.collection(SEATS).doc(String(seatId)).delete(); }
        window.approveSpeech = function(id, name) { db.collection(NOTIFICATIONS).add({ text: `${name} konuÅŸabilir.`, type: 'grant', timestamp: firebase.firestore.FieldValue.serverTimestamp() }); db.collection(SPEAK_REQ).doc(id).delete(); window.setSpeaker(name); }
        window.setSpeaker = function(name) { db.collection(SETTINGS).doc('flow').update({ current_speaker: name }); }
        window.toggleVoteVisibility = function() { db.collection(SETTINGS).doc('flow').get().then(d => db.collection(SETTINGS).doc('flow').update({ show_votes: !d.data().show_votes })); }
        window.startTimer = function(min) { const end = new Date(); end.setMinutes(end.getMinutes()+min); db.collection(SETTINGS).doc('flow').update({timer_end: firebase.firestore.Timestamp.fromDate(end)}); }
        window.stopTimer = function() { db.collection(SETTINGS).doc('flow').update({timer_end: null}); }

        // PROJECTOR
        window.openProjectorMode = function() { document.getElementById('login-screen').classList.add('hidden'); document.getElementById('projector-panel').classList.remove('hidden'); initProjectorData(); }
        function initProjectorData() {
            const grid = document.getElementById('proj-seat-grid');
            db.collection(SEATS).onSnapshot(snap => {
                const occupied = {}; snap.forEach(doc => occupied[doc.id] = doc.data().name);
                grid.innerHTML = '';
                for(let i=1; i<=35; i++) {
                    const div = document.createElement('div');
                    const isTaken = occupied[i];
                    div.className = `w-full aspect-square rounded border flex items-center justify-center p-0.5 text-center relative overflow-hidden ${isTaken ? 'bg-green-600 border-green-400 shadow' : 'bg-slate-800 border-slate-700 opacity-40'}`;
                    div.innerHTML = isTaken ? `<span class="text-[7px] font-bold text-white leading-none break-words line-clamp-2">${occupied[i]}</span>` : `<span class="text-slate-600 text-[9px] font-mono">${i}</span>`;
                    grid.appendChild(div);
                }
                document.getElementById('proj-jury-count').textContent = `${Object.keys(occupied).length}/35`;
            });

            db.collection(SETTINGS).doc('flow').onSnapshot(doc => {
                if(doc.exists) {
                    const d = doc.data();
                    document.getElementById('speaker-text').textContent = d.current_speaker;
                    const overlay = document.getElementById('vote-blind-overlay'), content = document.getElementById('vote-content');
                    if(d.show_votes) { overlay.classList.add('hidden'); content.classList.remove('blur-overlay'); } else { overlay.classList.remove('hidden'); content.classList.add('blur-overlay'); }
                    const tb = document.getElementById('timer-box');
                    if(d.timer_end) {
                        tb.classList.remove('hidden');
                        if(timerInterval) clearInterval(timerInterval);
                        timerInterval = setInterval(() => {
                            const now = new Date().getTime(), distance = d.timer_end.toDate().getTime() - now;
                            if (distance < 0) { clearInterval(timerInterval); document.getElementById('timer-display').textContent = "00:00"; }
                            else { const m = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60)), s = Math.floor((distance % (1000 * 60)) / 1000); document.getElementById('timer-display').textContent = (m<10?"0"+m:m)+":"+(s<10?"0"+s:s); }
                        }, 1000);
                    } else { tb.classList.add('hidden'); if(timerInterval) clearInterval(timerInterval); }
                }
            });

            setTimeout(() => { initialLoadComplete = true; }, 2000);
            db.collection(NOTIFICATIONS).orderBy('timestamp', 'desc').limit(1).onSnapshot(snap => {
                if(!initialLoadComplete) return;
                snap.docChanges().forEach(change => { if(change.type === "added") { 
                    const d = change.doc.data(); 
                    if((new Date()-d.timestamp.toDate())<10000) { 
                        
                        const overlay = document.getElementById('projector-overlay');
                        const icon = document.getElementById('overlay-icon');
                        const text = document.getElementById('overlay-text');
                        const container = document.getElementById('emoji-container'); // REAKSÄ°YON Ä°Ã‡Ä°N

                        if(d.type === 'reaction') {
                            // EMOJÄ° FIRLATMA
                            const emojiEl = document.createElement('div');
                            emojiEl.textContent = d.text;
                            emojiEl.className = 'emoji-float';
                            emojiEl.style.left = Math.random() * 90 + 5 + '%'; // Rastgele yatay konum
                            emojiEl.style.bottom = '0';
                            container.appendChild(emojiEl);
                            setTimeout(() => emojiEl.remove(), 3000);
                        } else {
                            // STANDART BÄ°LDÄ°RÄ°M
                            overlay.classList.remove('hidden');
                            text.textContent = d.text;
                            if(d.type === 'silence') { 
                                icon.className = 'fa-solid fa-bell-slash text-red-500 text-6xl'; 
                                document.getElementById('shh-sound').play(); 
                            } else if(d.type === 'applause') { 
                                icon.className = 'fa-solid fa-hands-clapping text-purple-500 text-6xl'; 
                                document.getElementById('applause-sound').play(); 
                                confetti({particleCount: 150, spread: 100});
                            } else if(d.type === 'question') {
                                icon.className = 'fa-solid fa-circle-question text-cyan-400 text-6xl';
                                document.getElementById('alert-sound').play();
                            } else {
                                icon.className = 'fa-solid fa-circle-info text-yellow-400 text-6xl';
                                document.getElementById('alert-sound').play();
                            }

                            setTimeout(() => { overlay.classList.add('hidden'); }, 4000);
                        }
                    } 
                } });
            });

            db.collection(CHAT).orderBy('timestamp','desc').limit(20).onSnapshot(s => {
                const f = document.getElementById('proj-chat-feed'); f.innerHTML='';
                s.forEach(d => {
                    const data = d.data();
                    const neonClass = getNeonColor(data.author);
                    const avIcon = avatars[data.avatar] || 'fa-solid fa-user';
                    const isTeacher = data.role === 'teacher';
                    const msgStyle = isTeacher ? 'vip-msg' : 'bg-slate-700/80 border-slate-500';
                    f.innerHTML += `<div class="${msgStyle} p-2 rounded mb-2 border-l-2 flex gap-2"><div class="w-6 h-6 rounded-full bg-slate-600 flex items-center justify-center"><i class="${isTeacher ? 'fa-solid fa-crown text-yellow-400' : avIcon} text-xs text-slate-300"></i></div><div><b class="${isTeacher ? 'text-yellow-400' : neonClass} text-xs block mb-1 font-black tracking-wide">${data.author}</b><span class="text-white text-sm leading-tight">${data.text}</span></div></div>`;
                });
            });

            db.collection('sim_sentiment').onSnapshot(s=>{ 
                let t=0, c=0; s.forEach(d=>{t+=d.data().val;c++}); 
                if(c>0) {
                    const avg = t/c;
                    document.getElementById('proj-sentiment-marker').style.left = avg+"%"; 
                    document.getElementById('proj-sentiment-val').textContent = avg.toFixed(0) + "%";
                }
            });
            db.collection(VOTES).onSnapshot(s => {
                let g=0, ng=0; s.forEach(d => d.data().vote === 'SUÃ‡LU' ? g++ : ng++);
                document.getElementById('proj-vote-guilty').textContent = g; document.getElementById('proj-vote-notguilty').textContent = ng;
                const t = g + ng; if(t > 0) { document.getElementById('proj-bar-guilty').style.width = (g/t*100) + "%"; document.getElementById('proj-bar-notguilty').style.width = (ng/t*100) + "%"; }
                const v = document.getElementById('proj-final-verdict'); if(g >= 18) { v.innerHTML="KARAR: <span class='text-red-500'>SUÃ‡LU</span>"; v.classList.remove('hidden'); } else if(ng >= 18) { v.innerHTML="KARAR: <span class='text-green-500'>SUÃ‡SUZ</span>"; v.classList.remove('hidden'); } else { v.classList.add('hidden'); }
            });
        }

        window.openJurorCard = async function(seatId, name, avatar) {
            const doc = await db.collection(SCORES).doc(String(seatId)).get();
            const score = doc.exists ? doc.data().val : 0;
            const avIcon = avatars[avatar] || 'fa-solid fa-user';
            document.getElementById('card-name').textContent = name; document.getElementById('card-seat').textContent = seatId; document.getElementById('card-score').textContent = score; document.getElementById('card-avatar').className = avIcon + " text-4xl text-white";
            document.getElementById('juror-card-modal').classList.remove('hidden');
        }

        window.resetSimulation = async function() {
            if(!confirm("TÃœM VERÄ°LER SÄ°LÄ°NECEK. ONAYLIYOR MUSUNUZ?")) return;
            const cols = [SEATS, VOTES, QUIZZES, SCORES, CHAT, SPEAK_REQ, NOTIFICATIONS, 'sim_answers', 'sim_sentiment', QUESTIONS];
            try {
                for (const col of cols) { const snap = await db.collection(col).get(); if (!snap.empty) { const batch = db.batch(); snap.docs.forEach(doc => batch.delete(doc.ref)); await batch.commit(); } }
                await db.collection(SETTINGS).doc('flow').set({current_speaker: 'Hakim', show_votes: true, timer_end: null});
                alert("Sistem SÄ±fÄ±rlandÄ±."); location.reload();
            } catch (error) { console.error(error); alert("Hata oluÅŸtu: " + error.message); }
        }

        window.openImage = function(src) { document.getElementById('modal-img').src=src; document.getElementById('image-modal').classList.remove('hidden'); }
        window.openVideoModal = function() { document.getElementById('video-modal').classList.remove('hidden'); }
        window.logoutUser = function() { 
            if(currentUser && currentUser.seatId) {
                db.collection(SEATS).doc(String(currentUser.seatId)).delete();
            }
            localStorage.clear(); location.reload(); 
        }
    </script>
</body>
</html>
