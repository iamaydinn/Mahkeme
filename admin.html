<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Adalet Sim√ºlasyonu | Sistem Y√∂neticisi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    
    <style>
        body { background-color: #0b0c15; color: #e2e8f0; font-family: 'Inter', sans-serif; overflow: hidden; }
        .mono { font-family: 'JetBrains Mono', monospace; }
        
        /* Sidebar & Layout */
        .glass-sidebar { background: rgba(15, 23, 42, 0.95); border-right: 1px solid #1e293b; }
        .sidebar-link { display: flex; align-items:center; gap: 12px; padding: 14px; border-radius: 10px; color: #94a3b8; transition: all 0.2s; cursor: pointer; font-weight: 600; font-size: 0.9rem; }
        .sidebar-link:hover { background: #1e293b; color: #fff; transform: translateX(5px); }
        .sidebar-link.active { background: linear-gradient(90deg, #2563eb 0%, #1d4ed8 100%); color: white; box-shadow: 0 4px 20px rgba(37, 99, 235, 0.3); }

        /* Kartlar */
        .card { background: #111827; border: 1px solid #1f2937; border-radius: 16px; overflow: hidden; position: relative; }
        .card-header { padding: 16px; border-bottom: 1px solid #1f2937; display: flex; justify-content: space-between; align-items: center; background: #111827; }
        .card-title { font-weight: 800; text-transform: uppercase; font-size: 0.75rem; letter-spacing: 0.05em; color: #9ca3af; }

        /* Form Elemanlarƒ± */
        input, select, textarea { background: #030712; border: 1px solid #374151; color: white; border-radius: 8px; padding: 10px 14px; font-size: 0.9rem; width: 100%; outline: none; transition: all 0.2s; }
        input:focus, select:focus, textarea:focus { border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2); }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-thumb { background: #374151; border-radius: 3px; }
        ::-webkit-scrollbar-track { background: transparent; }

        /* Toast Bildirim */
        #admin-toast { position: fixed; top: 20px; right: 20px; z-index: 10000; transform: translateX(200%); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        #admin-toast.show { transform: translateX(0); }

        /* Animasyonlar */
        .pulse-live { animation: pulse-red 2s infinite; }
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
    </style>
</head>
<body class="flex h-screen">

    <script src="https://www.gstatic.com/firebasejs/10.9.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.9.0/firebase-firestore-compat.js"></script>

    <div id="admin-toast" class="bg-slate-800 border-l-4 border-green-500 text-white px-6 py-4 rounded-lg shadow-2xl flex items-center gap-3 min-w-[300px]">
        <i class="fa-solid fa-circle-check text-green-500 text-xl"></i>
        <div>
            <h4 class="font-bold text-sm">Ba≈üarƒ±lƒ±</h4>
            <p id="toast-msg" class="text-xs text-slate-400">ƒ∞≈ülem tamamlandƒ±.</p>
        </div>
    </div>

    <div id="login-overlay" class="fixed inset-0 z-[100000] bg-[#020617] flex items-center justify-center">
        <div class="w-full max-w-sm p-10 rounded-3xl bg-slate-900/50 border border-slate-700 shadow-[0_0_100px_rgba(37,99,235,0.2)] text-center backdrop-blur-xl">
            <div class="w-20 h-20 bg-blue-600 rounded-2xl mx-auto mb-6 flex items-center justify-center shadow-lg shadow-blue-600/50">
                <i class="fa-solid fa-shield-halved text-4xl text-white"></i>
            </div>
            <h2 class="text-2xl font-black text-white mb-2 tracking-wide">Adalet Sim√ºlasyonu Sistem Y√∂neticisi</h2>
            <p class="text-slate-500 text-sm mb-8">Yetkili Giri≈üi</p>
            <form onsubmit="adminLogin(event)" class="space-y-4">
                <input type="text" id="adm-user" placeholder="Kullanƒ±cƒ± Adƒ±" class="bg-slate-950 border-slate-800 text-center">
                <input type="password" id="adm-pass" placeholder="≈ûifre" class="bg-slate-950 border-slate-800 text-center">
                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3.5 rounded-xl transition shadow-lg shadow-blue-600/30">Gƒ∞Rƒ∞≈û YAP</button>
            </form>
            <p id="login-error" class="text-red-500 text-xs mt-4 h-4 font-bold"></p>
        </div>
    </div>

    <aside id="sidebar" class="w-72 glass-sidebar flex flex-col z-20 hidden md:flex transition-all duration-300">
        <div class="p-8 border-b border-slate-800">
            <h1 class="text-xl font-black text-white tracking-wider flex items-center gap-2">
                <i class="fa-solid fa-layer-group text-blue-500"></i> SYS<span class="text-blue-500">ADMIN</span>
            </h1>
            <div class="mt-4 flex items-center gap-3 bg-slate-800/50 p-3 rounded-lg border border-slate-700/50">
                <div class="w-2 h-2 rounded-full bg-green-500 pulse-live"></div>
                <span class="text-xs font-mono text-green-400">Sƒ∞STEM ONLINE</span>
            </div>
        </div>
        
        <nav class="flex-1 p-6 space-y-2 overflow-y-auto">
            <div class="sidebar-link active" onclick="switchPage('dashboard', this)"><i class="fa-solid fa-chart-pie"></i> Genel Bakƒ±≈ü</div>
            <div class="sidebar-link" onclick="switchPage('users', this)"><i class="fa-solid fa-users-gear"></i> J√ºri Y√∂netimi</div>
            <div class="sidebar-link" onclick="switchPage('content', this)"><i class="fa-solid fa-folder-tree"></i> Delil & Dosya</div>
            <div class="sidebar-link" onclick="switchPage('communication', this)"><i class="fa-solid fa-tower-broadcast"></i> Duyuru & Chat</div>
            <div class="sidebar-link" onclick="switchPage('votes', this)"><i class="fa-solid fa-sliders"></i> Akƒ±≈ü Kontrol√º</div>
        </nav>

        <div class="p-6 border-t border-slate-800">
            <button onclick="switchPage('danger', null)" class="w-full bg-red-500/10 hover:bg-red-500/20 text-red-500 border border-red-500/30 py-3 rounded-lg text-xs font-bold transition flex items-center justify-center gap-2">
                <i class="fa-solid fa-triangle-exclamation"></i> ACƒ∞L DURUM
            </button>
        </div>
    </aside>

    <main id="main-content" class="flex-1 bg-[#0b0c15] flex flex-col min-w-0 overflow-hidden relative">
        <header class="h-20 border-b border-slate-800/50 flex justify-between items-center px-8 bg-[#0b0c15]/80 backdrop-blur z-10">
            <div>
                <h2 class="text-xl font-bold text-white tracking-wide" id="page-title">Genel Bakƒ±≈ü</h2>
                <p class="text-xs text-slate-500 mt-1">Sim√ºlasyon Y√∂netim Paneli v2.0</p>
            </div>
            <div class="flex gap-3">
                <button onclick="location.reload()" class="bg-slate-800 text-slate-400 hover:text-white px-4 py-2 rounded-lg text-xs font-bold transition border border-slate-700">
                    <i class="fa-solid fa-power-off mr-2"></i>√áIKI≈û
                </button>
            </div>
        </header>

        <div class="flex-1 overflow-y-auto p-8 relative scroll-smooth">
            
            <div id="page-dashboard" class="page-section max-w-6xl mx-auto animate-fade-in">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                    <div class="card p-5 border-l-4 border-blue-500"><div class="text-blue-400 text-xs font-bold uppercase mb-2">Aktif J√ºri</div><div class="text-4xl font-black text-white" id="stat-seats">0</div><i class="fa-solid fa-users absolute top-5 right-5 text-slate-800 text-4xl"></i></div>
                    <div class="card p-5 border-l-4 border-purple-500"><div class="text-purple-400 text-xs font-bold uppercase mb-2">Toplam Mesaj</div><div class="text-4xl font-black text-white" id="stat-msgs">0</div><i class="fa-solid fa-comments absolute top-5 right-5 text-slate-800 text-4xl"></i></div>
                    <div class="card p-5 border-l-4 border-green-500"><div class="text-green-400 text-xs font-bold uppercase mb-2">Kullanƒ±lan Oy</div><div class="text-4xl font-black text-white" id="stat-votes">0</div><i class="fa-solid fa-check-to-slot absolute top-5 right-5 text-slate-800 text-4xl"></i></div>
                    <div class="card p-5 border-l-4 border-yellow-500"><div class="text-yellow-400 text-xs font-bold uppercase mb-2">Konu≈ümacƒ±</div><div class="text-xl font-bold text-white truncate" id="stat-lastcmd">Bekleniyor...</div><i class="fa-solid fa-microphone absolute top-5 right-5 text-slate-800 text-4xl"></i></div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="card col-span-2">
                        <div class="card-header"><span class="card-title text-blue-400">CANLI OYLAMA ANALƒ∞Zƒ∞</span><span class="text-xs bg-slate-800 px-2 py-1 rounded text-slate-400">Anlƒ±k</span></div>
                        <div class="p-6 h-64 relative w-full flex justify-center">
                            <canvas id="votePieChart"></canvas>
                            <div id="no-vote-data" class="absolute inset-0 flex items-center justify-center text-slate-600 text-sm hidden">Hen√ºz oy kullanƒ±lmadƒ±</div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header"><span class="card-title text-yellow-400">HIZLI ƒ∞≈ûLEMLER</span></div>
                        <div class="p-6 space-y-3">
                            <button onclick="triggerClassEffect('silence')" class="w-full bg-red-500/10 border border-red-500/50 text-red-400 hover:bg-red-500 hover:text-white py-3 rounded-lg text-xs font-bold transition flex items-center justify-center gap-2"><i class="fa-solid fa-bell-slash"></i> SESSƒ∞ZLƒ∞K UYARISI</button>
                            <button onclick="triggerClassEffect('applause')" class="w-full bg-purple-500/10 border border-purple-500/50 text-purple-400 hover:bg-purple-500 hover:text-white py-3 rounded-lg text-xs font-bold transition flex items-center justify-center gap-2"><i class="fa-solid fa-hands-clapping"></i> ALKI≈û EFEKTƒ∞</button>
                            <button onclick="triggerClassEffect('bonus')" class="w-full bg-green-500/10 border border-green-500/50 text-green-400 hover:bg-green-500 hover:text-white py-3 rounded-lg text-xs font-bold transition flex items-center justify-center gap-2"><i class="fa-solid fa-gift"></i> HERKESE +5 PUAN</button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="page-users" class="page-section hidden max-w-6xl mx-auto">
                <div class="card mb-6 bg-blue-900/10 border-blue-800">
                    <div class="p-4 flex items-center gap-4">
                        <i class="fa-solid fa-circle-info text-blue-400 text-xl"></i>
                        <div>
                            <h3 class="text-blue-100 font-bold text-sm">√ñƒürenci Y√∂netim Paneli</h3>
                            <p class="text-blue-300/60 text-xs">√ñƒürencilere puan verebilir, uyarabilir veya sistemden atabilirsiniz.</p>
                        </div>
                    </div>
                </div>

                <div class="card p-0">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-slate-900 text-slate-400 text-xs uppercase font-bold sticky top-0">
                            <tr>
                                <th class="p-4 w-20">Koltuk</th>
                                <th class="p-4">√ñƒürenci Adƒ±</th>
                                <th class="p-4 w-24 text-center">Puan</th>
                                <th class="p-4 text-right">M√ºdahale</th>
                            </tr>
                        </thead>
                        <tbody id="admin-user-list" class="divide-y divide-slate-800/50 text-slate-300">
                            </tbody>
                    </table>
                </div>
            </div>

            <div id="page-content" class="page-section hidden max-w-4xl mx-auto">
                <div class="grid grid-cols-1 gap-6">
                    <div class="card border-blue-500/30">
                        <div class="card-header border-blue-500/20"><span class="card-title text-blue-400">‚ö° HIZLI DELƒ∞L Y√úKLEME</span></div>
                        <div class="p-6 space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <input type="text" id="ev-title" placeholder="Delil Ba≈ülƒ±ƒüƒ± (√ñrn: Olay Yeri)">
                                <select id="ev-type" class="bg-slate-900 border-slate-700">
                                    <option value="image">üì∏ G√∂rsel</option>
                                    <option value="video">üé• Video (MP4)</option>
                                    <option value="pdf">üìÑ PDF Dosyasƒ±</option>
                                    <option value="whatsapp">üí¨ WhatsApp</option>
                                </select>
                            </div>
                            <input type="text" id="ev-desc" placeholder="Alt A√ßƒ±klama (Opsiyonel)">
                            <input type="text" id="ev-url" placeholder="Dosya URL (https://...)">
                            <button onclick="addEvidence()" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-lg shadow-lg shadow-blue-600/20 transition">Sƒ∞STEME ENJEKTE ET & YANSIT</button>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header"><span class="card-title text-slate-400">Y√úKL√ú DELƒ∞LLER</span><span id="evidence-count" class="text-xs bg-slate-800 px-2 py-1 rounded">0</span></div>
                        <div class="max-h-[500px] overflow-y-auto">
                            <table class="w-full text-left text-xs">
                                <thead class="bg-slate-900 text-slate-400 uppercase sticky top-0">
                                    <tr><th class="p-3">√ñnizleme</th><th class="p-3">Ba≈ülƒ±k</th><th class="p-3 text-right">ƒ∞≈ülem</th></tr>
                                </thead>
                                <tbody id="evidence-manage-list" class="divide-y divide-slate-800"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div id="page-communication" class="page-section hidden max-w-4xl mx-auto space-y-6">
                <div class="card border-yellow-500/30">
                    <div class="card-header border-yellow-500/20"><span class="card-title text-yellow-400">üì¢ SOHBETE DUYURU GE√á</span></div>
                    <div class="p-6 flex gap-3">
                        <input type="text" id="admin-announce-input" placeholder="T√ºm √∂ƒürencilere iletilecek mesajƒ±nƒ±z..." class="flex-1 bg-yellow-900/10 border-yellow-500/30 focus:border-yellow-500 text-yellow-100">
                        <button onclick="sendAnnouncement()" class="bg-yellow-600 hover:bg-yellow-500 text-slate-900 font-bold px-6 rounded-lg transition"><i class="fa-solid fa-paper-plane mr-2"></i>G√ñNDER</button>
                    </div>
                </div>

                <div class="card h-[500px] flex flex-col">
                    <div class="card-header"><span class="card-title text-slate-400">CANLI SOHBET AKI≈ûI</span><button onclick="clearChat()" class="text-red-400 text-xs hover:text-white border border-red-900 px-2 py-1 rounded">TEMƒ∞ZLE</button></div>
                    <div id="chat-logs" class="flex-1 overflow-y-auto p-4 space-y-3 bg-[#0f111a]"></div>
                </div>
            </div>

            <div id="page-votes" class="page-section hidden max-w-4xl mx-auto space-y-6">
                <div class="card">
                    <div class="card-header"><span class="card-title text-cyan-400">KONU≈ûMACI K√úRS√úS√ú</span></div>
                    <div class="p-6 grid grid-cols-2 md:grid-cols-3 gap-3">
                        <button onclick="setSpeaker('Davacƒ± Avukatƒ±')" class="p-3 rounded-lg bg-blue-900/20 border border-blue-800 hover:bg-blue-600 hover:border-blue-500 text-blue-200 transition text-xs font-bold">Davacƒ± Avukatƒ±</button>
                        <button onclick="setSpeaker('Sanƒ±k Avukatƒ±')" class="p-3 rounded-lg bg-red-900/20 border border-red-800 hover:bg-red-600 hover:border-red-500 text-red-200 transition text-xs font-bold">Sanƒ±k Avukatƒ±</button>
                        <button onclick="setSpeaker('Sanƒ±k')" class="p-3 rounded-lg bg-slate-800 border border-slate-600 hover:bg-slate-700 text-white transition text-xs font-bold">SANIK</button>
                        <button onclick="setSpeaker('Davacƒ±')" class="p-3 rounded-lg bg-slate-800 border border-slate-600 hover:bg-slate-700 text-white transition text-xs font-bold">DAVACI</button>
                        <button onclick="setSpeaker('Tanƒ±k')" class="p-3 rounded-lg bg-slate-800 border border-slate-600 hover:bg-slate-700 text-white transition text-xs font-bold">TANIK</button>
                        <button onclick="setSpeaker('Hakim')" class="p-3 rounded-lg bg-yellow-600/20 border border-yellow-600 text-yellow-400 hover:bg-yellow-600 hover:text-white transition text-xs font-bold">HAKƒ∞M</button>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="card">
                        <div class="card-header"><span class="card-title text-red-400">S√úRE√á Y√ñNETƒ∞Mƒ∞</span></div>
                        <div class="p-6 flex flex-col gap-3">
                            <div class="flex gap-2">
                                <button onclick="startTimer(1)" class="flex-1 bg-slate-800 hover:bg-slate-700 py-2 rounded text-xs font-bold">1 DK</button>
                                <button onclick="startTimer(3)" class="flex-1 bg-slate-800 hover:bg-slate-700 py-2 rounded text-xs font-bold">3 DK</button>
                                <button onclick="stopTimer()" class="bg-red-900/50 hover:bg-red-600 text-red-200 py-2 px-4 rounded text-xs font-bold"><i class="fa-solid fa-stop"></i></button>
                            </div>
                            <button onclick="toggleVoteVisibility()" class="w-full bg-indigo-600/30 hover:bg-indigo-600 border border-indigo-500 text-indigo-100 py-3 rounded-lg text-xs font-bold transition">OYLARI Gƒ∞ZLE / G√ñSTER</button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="page-danger" class="page-section hidden max-w-2xl mx-auto space-y-6">
                <div class="bg-red-950/30 border border-red-500/30 p-6 rounded-2xl text-center">
                    <i class="fa-solid fa-triangle-exclamation text-5xl text-red-500 mb-4 block"></i>
                    <h2 class="text-xl font-bold text-white mb-2">KRƒ∞Tƒ∞K B√ñLGE</h2>
                    <p class="text-slate-400 text-sm mb-6">Buradaki i≈ülemler geri alƒ±namaz ve t√ºm sim√ºlasyonu etkiler.</p>
                    
                    <div class="space-y-3">
                        <button onclick="toggleMaintenance()" id="btn-maintenance" class="w-full bg-yellow-600 hover:bg-yellow-500 text-white font-bold py-4 rounded-xl transition">Sƒ∞STEMƒ∞ Kƒ∞Lƒ∞TLE (BAKIM MODU)</button>
                        <button onclick="wipeAllData()" class="w-full bg-red-800 hover:bg-red-700 text-white font-bold py-4 rounded-xl transition border-2 border-red-600">‚ö†Ô∏è T√úM VERƒ∞LERƒ∞ Sƒ∞L & SIFIRLA</button>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyB4afTGFkOqUjeVfqfHxgKCTbGHvftZIO4", authDomain: "mahkeme-sim.firebaseapp.com", projectId: "mahkeme-sim", storageBucket: "mahkeme-sim.firebasestorage.app", messagingSenderId: "573778878408", appId: "1:573778878408:web:67ab4ac00df3325ec6afd" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        const SEATS='sim_seats', VOTES='sim_votes', CHAT='sim_chat', SCORES='sim_scores', SETTINGS='sim_settings', EVIDENCE='sim_evidence', NOTIFICATIONS='sim_notifications';
        let voteChart = null;

        // --- Gƒ∞Rƒ∞≈û ---
        window.onload = function() { document.getElementById('login-overlay').classList.remove('hidden'); };
        function adminLogin(e) {
            e.preventDefault();
            const u = document.getElementById('adm-user').value; const p = document.getElementById('adm-pass').value;
            if(u === 'muhammet' && p === 'muhammet25') {
                document.getElementById('login-overlay').classList.add('hidden');
                document.getElementById('sidebar').classList.remove('hidden');
                document.getElementById('sidebar').classList.add('flex');
                initDataListeners(); switchPage('dashboard', document.querySelector('.sidebar-link'));
                showAdminToast('Giri≈ü Ba≈üarƒ±lƒ±', 'Sisteme ho≈ü geldiniz.');
            } else { document.getElementById('login-error').innerText = 'Hatalƒ± kimlik bilgisi.'; }
        }

        // --- SAYFA GE√áƒ∞≈ûƒ∞ ---
        window.switchPage = function(pageId, btn) {
            document.querySelectorAll('.page-section').forEach(el => el.classList.add('hidden'));
            const target = document.getElementById('page-' + pageId);
            if(target) target.classList.remove('hidden');
            if(btn) { document.querySelectorAll('.sidebar-link').forEach(el => el.classList.remove('active')); btn.classList.add('active'); }
            
            const titles = { 'dashboard': 'Genel Bakƒ±≈ü', 'users': 'J√ºri Y√∂netimi', 'content': 'Delil Dosyasƒ±', 'communication': 'ƒ∞leti≈üim Merkezi', 'votes': 'Akƒ±≈ü Kontrol√º', 'danger': 'ACƒ∞L DURUM' };
            document.getElementById('page-title').innerText = titles[pageId] || 'Panel';
            if(pageId === 'content') renderEvidenceManagement();
            if(pageId === 'communication') renderChatLogs();
        }

        // --- TOAST Bƒ∞LDƒ∞Rƒ∞Mƒ∞ ---
        function showAdminToast(title, msg) {
            const t = document.getElementById('admin-toast');
            t.querySelector('h4').innerText = title; t.querySelector('p').innerText = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 3000);
        }

        // --- VERƒ∞ Dƒ∞NLEYƒ∞Cƒ∞LERƒ∞ ---
        function initDataListeners() {
            // J√úRƒ∞ Lƒ∞STESƒ∞ & PUANLAR
            db.collection(SEATS).orderBy('seatId').onSnapshot(async (snap) => {
                const list = document.getElementById('admin-user-list');
                document.getElementById('stat-seats').innerText = snap.size;
                const scoresSnap = await db.collection(SCORES).get();
                const scores = {}; scoresSnap.forEach(d => scores[d.id] = d.data().val);

                list.innerHTML = '';
                snap.forEach(doc => {
                    const d = doc.data();
                    list.innerHTML += `
                        <tr class="hover:bg-slate-800/50 transition border-b border-slate-800/50 group">
                            <td class="p-4 font-mono text-yellow-500 font-bold">#${d.seatId}</td>
                            <td class="p-4 font-bold text-white flex items-center gap-2">
                                <div class="w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center text-xs"><i class="${d.avatar ? 'fa-solid fa-user' : 'fa-solid fa-user'}"></i></div>
                                ${d.name}
                            </td>
                            <td class="p-4 text-center font-mono text-blue-400 font-bold text-lg">${scores[d.seatId] || 0}</td>
                            <td class="p-4 text-right">
                                <div class="flex justify-end gap-2 opacity-100 sm:opacity-50 group-hover:opacity-100 transition">
                                    <button onclick="warnUser('${d.seatId}', '${d.name}')" title="Uyar" class="w-8 h-8 rounded bg-yellow-500/20 text-yellow-400 hover:bg-yellow-500 hover:text-white transition"><i class="fa-solid fa-bell"></i></button>
                                    <button onclick="rewardUser('${d.seatId}', 10)" title="+10 Puan" class="w-8 h-8 rounded bg-green-500/20 text-green-400 hover:bg-green-500 hover:text-white transition"><i class="fa-solid fa-plus"></i></button>
                                    <button onclick="kickUser('${d.seatId}')" title="At" class="w-8 h-8 rounded bg-red-500/20 text-red-400 hover:bg-red-500 hover:text-white transition"><i class="fa-solid fa-user-xmark"></i></button>
                                </div>
                            </td>
                        </tr>`;
                });
            });

            // CHART & OYLAR
            db.collection(VOTES).onSnapshot(s => {
                document.getElementById('stat-votes').innerText = s.size;
                updateChart(s);
            });

            // MESAJ SAYISI
            db.collection(CHAT).onSnapshot(snap => document.getElementById('stat-msgs').innerText = snap.size);

            // Sƒ∞STEM DURUMU
            db.collection(SETTINGS).doc('flow').onSnapshot(doc => {
                if(doc.exists) {
                    const d = doc.data();
                    const btn = document.getElementById('btn-maintenance');
                    document.getElementById('stat-lastcmd').innerText = d.current_speaker || 'YOK';
                    if(d.system_locked) {
                        btn.innerText = "Kƒ∞Lƒ∞Dƒ∞ A√á (Sƒ∞STEMƒ∞ AKTƒ∞F ET)";
                        btn.classList.replace('bg-yellow-600','bg-green-600');
                    } else {
                        btn.innerText = "Sƒ∞STEMƒ∞ Kƒ∞Lƒ∞TLE (BAKIM MODU)";
                        btn.classList.replace('bg-green-600','bg-yellow-600');
                    }
                }
            });
        }

        // --- GRAFƒ∞K G√úNCELLEME ---
        function updateChart(snap) {
            let guilty = 0, notGuilty = 0;
            snap.forEach(doc => { const v = doc.data().vote; if(v==='SU√áLU') guilty++; else if(v==='SU√áSUZ') notGuilty++; });

            if(guilty + notGuilty === 0) { document.getElementById('no-vote-data').classList.remove('hidden'); return; }
            document.getElementById('no-vote-data').classList.add('hidden');

            const ctx = document.getElementById('votePieChart').getContext('2d');
            if(voteChart) voteChart.destroy();
            
            voteChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Su√ßlu', 'Su√ßsuz'],
                    datasets: [{
                        data: [guilty, notGuilty],
                        backgroundColor: ['#ef4444', '#22c55e'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom', labels: { color: '#94a3b8' } } }
                }
            });
        }

        // --- DELƒ∞L Y√ñNETƒ∞Mƒ∞ ---
        window.addEvidence = function() {
            const title = document.getElementById('ev-title').value;
            const desc = document.getElementById('ev-desc').value;
            const url = document.getElementById('ev-url').value;
            const type = document.getElementById('ev-type').value;

            if(!title || !url) return alert("Ba≈ülƒ±k ve URL zorunludur.");
            
            db.collection(EVIDENCE).add({ title, desc, url, type, timestamp: firebase.firestore.FieldValue.serverTimestamp() })
            .then(() => {
                // TAHTA Bƒ∞LDƒ∞Rƒ∞Mƒ∞
                db.collection(NOTIFICATIONS).add({ text: title, type: 'evidence_new', timestamp: firebase.firestore.FieldValue.serverTimestamp() });
                showAdminToast("Ba≈üarƒ±lƒ±", "Delil eklendi ve sƒ±nƒ±fa yansƒ±tƒ±ldƒ±.");
                document.getElementById('ev-title').value = ''; document.getElementById('ev-url').value = '';
            });
        }

        window.deleteEvidence = function(id) { if(confirm("Silinsin mi?")) db.collection(EVIDENCE).doc(id).delete().then(()=> showAdminToast("Silindi","Delil kaldƒ±rƒ±ldƒ±.")); }

        function renderEvidenceManagement() {
            db.collection(EVIDENCE).orderBy('timestamp', 'desc').onSnapshot(snap => {
                const list = document.getElementById('evidence-manage-list');
                document.getElementById('evidence-count').innerText = snap.size;
                list.innerHTML = '';
                snap.forEach(doc => {
                    const d = doc.data();
                    let preview = '';
                    if(d.type === 'image' || d.type === 'whatsapp') preview = `<img src="${d.url}" class="w-8 h-8 rounded object-cover border border-slate-600">`;
                    else if(d.type === 'video') preview = `<div class="w-8 h-8 rounded bg-red-900 flex items-center justify-center text-red-400"><i class="fa-solid fa-video"></i></div>`;
                    else preview = `<div class="w-8 h-8 rounded bg-orange-900 flex items-center justify-center text-orange-400"><i class="fa-solid fa-file-pdf"></i></div>`;

                    list.innerHTML += `
                        <tr class="border-b border-slate-800 hover:bg-slate-800/50">
                            <td class="p-3">${preview}</td>
                            <td class="p-3"><div class="font-bold text-slate-200 text-xs">${d.title}</div><div class="text-[10px] text-slate-500 uppercase">${d.type}</div></td>
                            <td class="p-3 text-right">
                                <button onclick="deleteEvidence('${doc.id}')" class="text-red-400 hover:text-white bg-red-900/20 hover:bg-red-600 px-3 py-1 rounded text-xs transition"><i class="fa-solid fa-trash"></i></button>
                            </td>
                        </tr>`;
                });
            });
        }

        // --- ƒ∞LETƒ∞≈ûƒ∞M & J√úRƒ∞ AKSƒ∞YONLARI ---
        function renderChatLogs() {
            db.collection(CHAT).orderBy('timestamp', 'desc').limit(50).onSnapshot(snap => {
                 const feed = document.getElementById('chat-logs'); feed.innerHTML = '';
                 snap.forEach(doc => {
                     const d = doc.data();
                     const isSystem = d.role === 'admin' || d.role === 'system';
                     const style = isSystem ? 'border-l-2 border-yellow-500 pl-2' : '';
                     const color = isSystem ? 'text-yellow-400' : 'text-blue-400';
                     feed.innerHTML += `<div class="p-2 border-b border-slate-800/50 ${style}"><div class="flex justify-between text-[10px] text-slate-500"><span class="${color} font-bold uppercase">${d.author}</span><span>${d.timestamp ? new Date(d.timestamp.seconds*1000).toLocaleTimeString() : ''}</span></div><div class="text-xs text-white mt-1">${d.text}</div></div>`;
                 });
            });
        }

        window.sendAnnouncement = function() {
            const txt = document.getElementById('admin-announce-input').value;
            if(!txt) return;
            db.collection(CHAT).add({ text: txt, author: 'Sƒ∞STEM DUYURUSU', seatId: 'SYS', role: 'admin', timestamp: firebase.firestore.FieldValue.serverTimestamp() });
            showAdminToast("G√∂nderildi", "Duyuru sohbete sabitlendi.");
            document.getElementById('admin-announce-input').value = '';
        }

        window.clearChat = function() { if(confirm("T√ºm sohbet silinsin mi?")) { db.collection(CHAT).get().then(s => { s.forEach(d => d.ref.delete()); showAdminToast("Temizlendi","Sohbet ge√ßmi≈üi silindi."); }); } }

        window.warnUser = function(seatId, name) {
            // √ñƒürenciye √∂zel bildirim gibi √ßalƒ±≈ümasƒ± i√ßin Chat'e etiketli mesaj atƒ±yoruz
            const msg = `‚ö†Ô∏è @${name} (Koltuk ${seatId}): L√ºtfen duru≈ümaya odaklanƒ±nƒ±z!`;
            db.collection(CHAT).add({ text: msg, author: 'HAKƒ∞M', seatId: 'SYS', role: 'admin', timestamp: firebase.firestore.FieldValue.serverTimestamp() });
            showAdminToast("Uyarƒ±ldƒ±", `${name} kullanƒ±cƒ±sƒ±na uyarƒ± g√∂nderildi.`);
        }

        window.rewardUser = function(seatId, amount) {
            db.collection(SCORES).doc(String(seatId)).update({ val: firebase.firestore.FieldValue.increment(amount) });
            showAdminToast("Puan Verildi", `Koltuk ${seatId} i√ßin +${amount} puan.`);
        }

        window.kickUser = function(seatId) {
            if(confirm("Kullanƒ±cƒ± atƒ±lsƒ±n mƒ±?")) {
                db.collection(SEATS).doc(String(seatId)).delete();
                db.collection(SCORES).doc(String(seatId)).delete();
                showAdminToast("Atƒ±ldƒ±", "Kullanƒ±cƒ± sistemden √ßƒ±karƒ±ldƒ±.");
            }
        }

        // --- Sƒ∞STEM KONTROLLERƒ∞ ---
        window.triggerClassEffect = function(type) { db.collection(NOTIFICATIONS).add({ type, text: 'Admin Action', timestamp: firebase.firestore.FieldValue.serverTimestamp() }); showAdminToast("Efekt", "Sƒ±nƒ±fa efekt g√∂nderildi."); }
        window.setSpeaker = function(name) { db.collection(SETTINGS).doc('flow').update({ current_speaker: name }); }
        window.startTimer = function(m) { const end = new Date(); end.setMinutes(end.getMinutes()+m); db.collection(SETTINGS).doc('flow').update({timer_end: firebase.firestore.Timestamp.fromDate(end)}); }
        window.stopTimer = function() { db.collection(SETTINGS).doc('flow').update({timer_end: null}); }
        window.toggleVoteVisibility = function() { db.collection(SETTINGS).doc('flow').get().then(d => db.collection(SETTINGS).doc('flow').update({ show_votes: !d.data().show_votes })); }
        
        window.toggleMaintenance = function() { 
            const ref = db.collection(SETTINGS).doc('flow'); 
            ref.get().then(d => ref.update({system_locked: !d.data().system_locked})); 
            showAdminToast("Mod Deƒüi≈üti", "Sistem kilit durumu g√ºncellendi.");
        }

        window.wipeAllData = async function() {
            if(prompt("Onaylamak i√ßin 'Sƒ∞L' yazƒ±n:") !== 'Sƒ∞L') return;
            const cols = [SEATS, VOTES, CHAT, SCORES, EVIDENCE, NOTIFICATIONS, 'sim_quizzes', 'sim_answers', 'sim_speak_requests', 'sim_questions'];
            for(const col of cols) { const snap = await db.collection(col).get(); const batch = db.batch(); snap.docs.forEach(d => batch.delete(d.ref)); await batch.commit(); }
            showAdminToast("SIFIRLANDI", "T√ºm veritabanƒ± temizlendi.");
            setTimeout(() => location.reload(), 1500);
        }
    </script>
</body>
</html>
