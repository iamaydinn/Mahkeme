<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SİSTEM YÖNETİCİSİ | Ultimate Control</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body { background-color: #0f172a; color: #e2e8f0; font-family: 'Inter', sans-serif; }
        .mono { font-family: 'JetBrains Mono', monospace; }
        
        /* Neon Çerçeve Efekti */
        .neon-border { position: relative; background: #1e293b; border-radius: 12px; z-index: 1; overflow: hidden; }
        .neon-border::before {
            content: ""; position: absolute; inset: -2px; border-radius: 14px; padding: 2px;
            background: linear-gradient(45deg, #0ea5e9, #3b82f6, #0ea5e9);
            -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor; mask-composite: exclude; z-index: -1;
            animation: spin-glow 4s linear infinite;
        }
        @keyframes spin-glow { 0% { filter: hue-rotate(0deg); } 100% { filter: hue-rotate(360deg); } }

        /* Sidebar Stil */
        .sidebar-link { display: flex; align-items:center; gap: 10px; padding: 12px; border-radius: 8px; color: #94a3b8; transition: all 0.2s; cursor: pointer; }
        .sidebar-link:hover { background: #1e293b; color: #fff; }
        .sidebar-link.active { background: linear-gradient(90deg, #0ea5e9 0%, #0284c7 100%); color: white; box-shadow: 0 0 15px rgba(14, 165, 233, 0.3); }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
        
        /* Input */
        input, select, textarea { background: #0f111a; border: 1px solid #334155; color: white; border-radius: 6px; padding: 8px 12px; font-size: 0.9rem; width: 100%; outline: none; transition: border 0.2s; }
        input:focus, select:focus, textarea:focus { border-color: #38bdf8; }
    </style>
</head>
<body class="flex h-screen overflow-hidden">

    <script src="https://www.gstatic.com/firebasejs/10.9.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.9.0/firebase-firestore-compat.js"></script>

    <!-- GİRİŞ EKRANI -->
    <div id="login-overlay" class="fixed inset-0 z-[100000] bg-[#0b0c15] flex items-center justify-center">
        <div class="w-full max-w-sm p-8 rounded-2xl bg-slate-900 border border-slate-700 shadow-2xl text-center border-t-4 border-blue-600">
            <i class="fa-solid fa-user-shield text-5xl text-blue-500 mb-4"></i>
            <h2 class="text-xl font-black text-white mb-6">SİSTEM YÖNETİCİSİ</h2>
            <form onsubmit="adminLogin(event)" class="space-y-4">
                <input type="text" id="adm-user" placeholder="Kullanıcı Adı: " class="text-center">
                <input type="password" id="adm-pass" placeholder="Parola: " class="text-center">
                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded transition shadow-lg">ERİŞİM İSTE</button>
            </form>
            <p id="login-error" class="text-red-500 text-xs mt-4 h-4"></p>
        </div>
    </div>

    <!-- SIDEBAR -->
    <aside id="sidebar" class="w-64 bg-[#0f111a] border-r border-[#2a2d3d] flex flex-col z-10 hidden md:flex">
        <div class="p-6 border-b border-[#2a2d3d] bg-[#1a1d2d]">
            <h1 class="text-xl font-black text-white tracking-wider flex items-center gap-2">
                <i class="fa-solid fa-screwdriver-wrench text-blue-500"></i> SYS<span class="text-blue-500">CONTROL</span>
            </h1>
            <p class="text-xs text-slate-500 mt-1 mono">v42.1-pro</p>
        </div>
        <nav class="flex-1 p-4 space-y-2 overflow-y-auto">
            <div class="sidebar-link active" onclick="switchPage('dashboard', this)"><i class="fa-solid fa-chart-line"></i> Genel Durum</div>
            <div class="sidebar-link" onclick="switchPage('users', this)"><i class="fa-solid fa-users"></i> Kullanıcı Yönetimi</div>
            <div class="sidebar-link" onclick="switchPage('content', this)"><i class="fa-solid fa-folder-open"></i> Delil Yönetimi</div>
            <div class="sidebar-link" onclick="switchPage('votes', this)"><i class="fa-solid fa-shuffle"></i> Akış Denetimi</div>
            <div class="sidebar-link" onclick="switchPage('messages', this)"><i class="fa-solid fa-bullhorn"></i> Bildirim & Chat</div>
            <div class="sidebar-link text-red-400 hover:text-red-300" onclick="switchPage('danger', this)"><i class="fa-solid fa-biohazard"></i> Kilit & Sıfırlama</div>
        </nav>
        <div class="p-4 border-t border-[#2a2d3d]">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 rounded-full bg-blue-900/50 flex items-center justify-center text-blue-400 font-bold border border-blue-800">M</div>
                <div>
                    <p class="text-xs font-bold text-white">Muhammet Emin Aydın.</p>
                    <p class="text-[10px] text-green-500">● Yönetici</p>
                </div>
            </div>
        </div>
    </aside>

    <!-- MAIN CONTENT -->
    <main id="main-content" class="flex-1 bg-[#0b0c15] flex flex-col min-w-0 relative">
        <header class="h-16 border-b border-[#2a2d3d] flex justify-between items-center px-8 bg-[#0f111a]">
            <h2 class="text-xl font-bold text-white tracking-wide" id="page-title">Gösterge Paneli</h2>
            <button onclick="location.reload()" class="text-xs bg-red-600 hover:bg-red-500 text-white px-4 py-2 rounded font-bold transition">SİSTEMİ TERK ET</button>
        </header>

        <div class="flex-1 overflow-y-auto p-8">

            <!-- 1. DASHBOARD -->
            <div id="page-dashboard" class="page-section space-y-6">
                <h3 class="text-sm font-bold text-cyan-400 uppercase">// CANLI TELEMETRİ</h3>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                    <div class="card border-l-4 border-green-500"><div class="text-slate-400 text-xs font-bold uppercase mb-1">Aktif Jüri</div><div class="text-4xl font-bold text-white" id="stat-seats">0</div></div>
                    <div class="card border-l-4 border-blue-500"><div class="text-slate-400 text-xs font-bold uppercase mb-1">Toplam Oy</div><div class="text-4xl font-bold text-white" id="stat-votes">0</div></div>
                    <div class="card border-l-4 border-yellow-500"><div class="text-slate-400 text-xs font-bold uppercase mb-1">Sohbet Logları</div><div class="text-4xl font-bold text-white" id="stat-msgs">0</div></div>
                    <div class="card border-l-4 border-indigo-500"><div class="text-slate-400 text-xs font-bold uppercase mb-1">Sistem Durumu</div><div class="text-xl font-bold text-white" id="stat-status">NORMAL</div></div>
                </div>

                <div class="card">
                    <div class="card-header"><span class="card-title">CANLI VERİ AKIŞI</span></div>
                    <p class="text-sm text-slate-400 mono">Son Komut: <span id="stat-lastcmd" class="text-blue-400">YOK</span></p>
                </div>
            </div>

            <!-- 2. KULLANICI YÖNETİMİ -->
            <div id="page-users" class="page-section hidden">
                <h3 class="text-sm font-bold text-cyan-400 uppercase">// KULLANICI LİSTESİ & İŞLEMLER</h3>
                <div class="card p-0 overflow-hidden">
                    <table class="w-full text-xs text-left">
                        <thead class="bg-[#1a1d2d] text-slate-400 uppercase sticky top-0">
                            <tr><th class="p-4">Koltuk</th><th class="p-4">İsim</th><th class="p-4">Puan</th><th class="p-4 text-right">İşlem</th></tr>
                        </thead>
                        <tbody id="admin-user-list" class="divide-y divide-slate-800">
                            <!-- JS ile dolacak -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- 3. DELİL YÖNETİMİ -->
            <div id="page-content" class="page-section hidden space-y-6">
                <h3 class="text-sm font-bold text-cyan-400 uppercase">// DELİL YÖNETİMİ</h3>
                
                <!-- Delil Yükleme Formu -->
                <div class="neon-border p-6">
                    <div class="card-header border-b border-slate-700 mb-4"><span class="card-title text-yellow-400">YENİ DELİL YÜKLE (URL)</span></div>
                    <div class="space-y-3">
                        <input type="text" id="ev-title" placeholder="Delil Başlığı (Örn: Olay Yeri)">
                        <input type="text" id="ev-desc" placeholder="Kısa Açıklama (Opsiyonel)">
                        <input type="text" id="ev-url" placeholder="Resim veya Video URL'si">
                        <select id="ev-type" class="w-full">
                            <option value="image">Görsel (Resim)</option>
                            <option value="video">Video</option>
                            <option value="whatsapp">WhatsApp Kaydı</option>
                        </select>
                        <button onclick="addEvidence()" class="w-full bg-green-600 hover:bg-green-500 text-white py-3 rounded font-bold text-sm mt-2">SİSTEME ENJEKTE ET</button>
                    </div>
                </div>

                <!-- YÜKLENEN DELİLLER LİSTESİ -->
                <div class="card p-0 overflow-hidden">
                    <div class="p-4 border-b border-slate-700 bg-[#1a1d2d] flex justify-between">
                        <span class="card-title text-blue-400">YÜKLÜ DELİLLER</span>
                        <span class="text-xs text-slate-400" id="evidence-count">0 Delil</span>
                    </div>
                    <div class="max-h-96 overflow-y-auto">
                        <table class="w-full text-xs text-left">
                            <thead class="bg-[#1a1d2d] text-slate-400 uppercase sticky top-0">
                                <tr><th class="p-3">Adı</th><th class="p-3">Türü</th><th class="p-3 text-right">Sil</th></tr>
                            </thead>
                            <tbody id="evidence-manage-list" class="divide-y divide-slate-800">
                                <!-- JS ile dolacak -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 4. AKIŞ & OYLAMA -->
            <div id="page-votes" class="page-section hidden space-y-6">
                <h3 class="text-sm font-bold text-cyan-400 uppercase">// DURUŞMA VE OYLAMA KONTROLÜ</h3>
                <div class="card">
                    <div class="card-header"><span class="card-title">AKIL TAHTA KONUŞMACI KONTROLÜ</span></div>
                    <div class="grid grid-cols-3 gap-2">
                        <button onclick="setSpeaker('Davacı Avukatı')" class="py-2 rounded bg-blue-600/50 text-blue-300 text-xs">Davacı Av.</button>
                        <button onclick="setSpeaker('Sanık Avukatı')" class="py-2 rounded bg-red-600/50 text-red-300 text-xs">Sanık Av.</button>
                        <button onclick="setSpeaker('Sanık')" class="py-2 rounded bg-red-600 text-white text-xs font-bold">SANIK</button>
                        <button onclick="setSpeaker('Davacı')" class="py-2 rounded bg-blue-600 text-white text-xs font-bold">DAVACI</button>
                        <button onclick="setSpeaker('Tanık')" class="py-2 rounded bg-yellow-600 text-white text-xs font-bold">TANIK</button>
                        <button onclick="setSpeaker('Hakim')" class="py-2 rounded bg-green-600 text-white text-xs font-bold">HAKİM</button>
                    </div>
                </div>
            </div>

            <!-- 5. BİLDİRİM & CHAT -->
            <div id="page-messages" class="page-section hidden space-y-6">
                <h3 class="text-sm font-bold text-cyan-400 uppercase">// İLETİŞİM KANALLARI</h3>
                <div class="card">
                    <div class="card-header"><span class="card-title">CANLI CHAT İZLEME (50 MESAJ)</span></div>
                    <div id="chat-logs" class="max-h-64 overflow-y-auto space-y-2 text-xs"></div>
                </div>
            </div>

            <!-- 6. ACİL DURUM -->
            <div id="page-danger" class="page-section hidden space-y-6">
                <h3 class="text-sm font-bold text-red-500 uppercase">// KRİTİK İŞLEMLER</h3>
                <div class="card border-red-900/50 bg-red-950/10">
                    <div class="card-header"><span class="card-title text-red-500">SİSTEM KİLİDİ</span></div>
                    <p class="text-sm text-slate-400 mb-4">Olası kriz anlarında tüm kullanıcı ekranlarını duraklatır.</p>
                    <button onclick="toggleMaintenance()" id="btn-maintenance" class="w-full bg-yellow-600 hover:bg-yellow-500 text-white px-6 py-3 rounded font-bold">SİSTEMİ KİLİTLE</button>
                </div>
                <div class="card border-red-900/50 bg-red-950/10">
                    <button onclick="wipeAllData()" class="w-full bg-red-700 hover:bg-red-600 text-white py-3 rounded font-bold">FABRİKA AYARLARINA DÖN</button>
                </div>
            </div>
        </div>
    </main>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyB4afTGFkOqUjeVfqfHxgKCTbGHvftZIO4", authDomain: "mahkeme-sim.firebaseapp.com", projectId: "mahkeme-sim", storageBucket: "mahkeme-sim.firebasestorage.app", messagingSenderId: "573778878408", appId: "1:573778878408:web:67ab4ac00df3325ec6afd" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        const SEATS='sim_seats', VOTES='sim_votes', CHAT='sim_chat', SCORES='sim_scores', SETTINGS='sim_settings', EVIDENCE='sim_evidence';

        // --- GİRİŞ VE NAVİGASYON ---
        window.onload = function() {
            // İlk açılışta login ekranını göster
            document.getElementById('login-overlay').classList.remove('hidden');
        };

        function adminLogin(e) {
            e.preventDefault();
            const u = document.getElementById('adm-user').value;
            const p = document.getElementById('adm-pass').value;
            if(u === 'muhammet' && p === 'muhammet25') {
                document.getElementById('login-overlay').classList.add('hidden');
                document.getElementById('sidebar').classList.remove('hidden');
                document.getElementById('main-content').classList.remove('hidden');
                initDataListeners();
                // Sayfayı açarken Delil Yönetimi listesini yükle
                switchPage('dashboard', document.querySelector('.sidebar-link'));
            } else {
                document.getElementById('login-error').innerText = 'Hatalı kimlik bilgisi.';
            }
        }

        window.switchPage = function(pageId, btn) {
            document.querySelectorAll('.page-section').forEach(el => el.classList.add('hidden'));
            const target = document.getElementById('page-' + pageId);
            if(target) target.classList.remove('hidden');

            document.querySelectorAll('.sidebar-link').forEach(el => el.classList.remove('active'));
            if(btn) btn.classList.add('active');

            const titles = { 'dashboard': 'Gösterge Paneli', 'users': 'Kullanıcı Yönetimi', 'content': 'Delil Yönetimi', 'votes': 'Akış & Oylama', 'messages': 'Bildirim & Chat', 'danger': 'Acil Durum Bölgesi' };
            document.getElementById('page-title').innerText = titles[pageId] || 'Panel';
            if(pageId === 'content') renderEvidenceManagement();
            if(pageId === 'messages') renderChatLogs();
        }

        // --- VERİ DİNLEYİCİLERİ ---
        function initDataListeners() {
            // Kullanıcı Listesi & Puanlar
            db.collection(SEATS).orderBy('seatId').onSnapshot(async (snap) => {
                const list = document.getElementById('admin-user-list');
                document.getElementById('stat-seats').innerText = snap.size;
                
                const scoresSnap = await db.collection(SCORES).get();
                const scores = {}; scoresSnap.forEach(d => scores[d.id] = d.data().val);

                list.innerHTML = '';
                snap.forEach(doc => {
                    const d = doc.data();
                    const score = scores[d.seatId] || 0;
                    list.innerHTML += `
                        <tr class="border-b border-slate-800 hover:bg-slate-800/50 transition">
                            <td class="p-4 font-mono text-yellow-500">#${d.seatId}</td>
                            <td class="p-4 font-bold text-white">${d.name}</td>
                            <td class="p-4 font-mono text-blue-400">${score}</td>
                            <td class="p-4 text-right">
                                <button onclick="kickUser('${d.seatId}')" class="text-red-500 hover:text-white border border-red-900 hover:bg-red-600 px-3 py-1 rounded text-xs transition">AT</button>
                            </td>
                        </tr>
                    `;
                });
            });

            // Oylar, Mesajlar, Akış
            db.collection(VOTES).onSnapshot(s => document.getElementById('stat-votes').innerText = s.size);
            db.collection(CHAT).orderBy('timestamp', 'desc').limit(50).onSnapshot(snap => {
                 document.getElementById('stat-msgs').innerText = snap.size;
            });

            // Bakım Modu Durumu
            db.collection(SETTINGS).doc('flow').onSnapshot(doc => {
                if(doc.exists) {
                    const d = doc.data();
                    const locked = d.system_locked;
                    const btn = document.getElementById('btn-maintenance');
                    const stat = document.getElementById('stat-status');
                    
                    if(btn && stat) {
                        if(locked) {
                            btn.innerText = "KİLİDİ AÇ (SİSTEMİ AKTİF ET)";
                            btn.className = "w-full bg-green-600 hover:bg-green-500 text-white py-3 rounded font-bold";
                            stat.innerText = "BAKIMDA (KİLİTLİ)";
                            stat.classList.add('text-red-500');
                        } else {
                            btn.innerText = "SİSTEMİ KİLİTLE";
                            btn.className = "w-full bg-yellow-600 hover:bg-yellow-500 text-white py-3 rounded font-bold";
                            stat.innerText = "AKTİF";
                            stat.classList.remove('text-red-500');
                        }
                    }
                    document.getElementById('stat-lastcmd').innerText = d.current_speaker;
                }
            });
        }
        
        // --- İÇERİK YÖNETİMİ ---
        
        // 1. Delil Yükleme (Admin)
        window.addEvidence = function() {
            const title = document.getElementById('ev-title').value;
            const desc = document.getElementById('ev-desc').value;
            const url = document.getElementById('ev-url').value;
            const type = document.getElementById('ev-type').value;

            if(!title || !url) return alert("Başlık ve URL zorunludur.");

            db.collection(EVIDENCE).add({ title, desc, url, type, timestamp: firebase.firestore.FieldValue.serverTimestamp() })
                .then(() => {
                    alert("Delil sisteme eklendi ve tüm cihazlara gönderildi.");
                    document.getElementById('ev-title').value = '';
                    document.getElementById('ev-desc').value = '';
                    document.getElementById('ev-url').value = '';
                })
                .catch(e => alert("Yükleme Hatası: " + e.message));
        }

        // 2. Delil Silme
        window.deleteEvidence = function(docId) {
            if(confirm('Bu delili silmek istediğinize emin misiniz?')) {
                db.collection(EVIDENCE).doc(docId).delete()
                    .then(() => alert("Delil silindi."));
            }
        }
        
        // 3. Yüklü Delilleri Listeleme (Canlı Dinleyici)
        function renderEvidenceManagement() {
            db.collection(EVIDENCE).orderBy('timestamp', 'desc').onSnapshot(snap => {
                const list = document.getElementById('evidence-manage-list');
                const count = document.getElementById('evidence-count');
                
                if (!list) return;
                list.innerHTML = '';
                count.innerText = snap.size + ' Delil';

                snap.forEach(doc => {
                    const d = doc.data();
                    const icon = d.type === 'video' ? 'fa-video' : (d.type === 'whatsapp' ? 'fa-brands fa-whatsapp' : 'fa-file-image');
                    
                    list.innerHTML += `
                        <tr class="border-b border-slate-800 hover:bg-slate-800/50">
                            <td class="p-3"><i class="fa-solid ${icon} mr-2 text-blue-400"></i> ${d.title}</td>
                            <td class="p-3 text-xs text-slate-500">${d.type.toUpperCase()}</td>
                            <td class="p-3 text-right">
                                <button onclick="deleteEvidence('${doc.id}')" class="bg-red-700/30 text-red-400 hover:bg-red-700 hover:text-white px-3 py-1 rounded text-xs transition">SİL</button>
                            </td>
                        </tr>
                    `;
                });
            });
        }
        
        // 4. Chat Logs
        function renderChatLogs() {
            db.collection(CHAT).orderBy('timestamp', 'desc').limit(50).onSnapshot(snap => {
                 const feed = document.getElementById('chat-logs');
                 if(!feed) return;
                 feed.innerHTML = '';
                 snap.forEach(doc => {
                     const d = doc.data();
                     const time = d.timestamp ? new Date(d.timestamp.seconds * 1000).toLocaleTimeString() : '—';
                     const roleColor = d.role === 'admin' ? 'text-red-500' : 'text-blue-400';
                     feed.innerHTML += `<div class="p-2 border-b border-slate-800/50"><div class="flex justify-between text-xs text-slate-500"><span class="${roleColor} font-bold">${d.author}</span><span>${time}</span></div><div class="text-sm text-white">${d.text}</div></div>`;
                 });
            });
        }


        // --- GENEL AKSİYONLAR ---
        
        window.kickUser = function(seatId) {
            if(confirm(`Kullanıcı #${seatId} atılsın mı?`)) db.collection(SEATS).doc(String(seatId)).delete();
        }

        window.setSpeaker = function(name) {
            db.collection('sim_settings').doc('flow').update({ current_speaker: name });
        }

        window.toggleMaintenance = function() {
            const ref = db.collection('sim_settings').doc('flow');
            ref.get().then(doc => {
                const current = doc.exists ? doc.data().system_locked : false;
                ref.set({ system_locked: !current }, { merge: true });
            });
        }

        window.wipeAllData = async function() {
            if(prompt("Onaylamak için SİL yazın") !== 'SİL') return;
            const cols = [SEATS, VOTES, CHAT, SCORES, 'sim_quizzes', 'sim_speak_requests', 'sim_notifications', 'sim_answers', 'sim_sentiment', 'sim_questions', EVIDENCE];
            for(const col of cols) {
                const snap = await db.collection(col).get();
                if (!snap.empty) {
                    const batch = db.batch();
                    snap.docs.forEach(doc => batch.delete(doc.ref));
                    await batch.commit();
                }
            }
            await db.collection('sim_settings').doc('flow').set({current_speaker: 'Hakim', show_votes: true, system_locked: false});
            alert("VERİTABANI TEMİZLENDİ.");
            location.reload();
        }
    </script>
</body>
</html>
